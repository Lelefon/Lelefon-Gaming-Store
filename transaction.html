<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Lelefon â€¢ Transactions</title>
<link rel="icon" type="image/png" href="images/lelefonlogo2.png?v=2" sizes="192x192">
<link rel="stylesheet" href="homestyle.css"/>
<style>
  .wrap{width:min(1100px,92vw);margin:24px auto}
  .card{border:1px solid #e6e6e6;border-radius:12px;background:#fff;padding:14px}
  .order{border:1px solid #eee;border-radius:12px;padding:12px;margin-bottom:10px}
  .head{display:flex;gap:8px;justify-content:space-between;align-items:center}
  .status{padding:4px 10px;border-radius:999px;border:1px solid #e6e6e6;font-weight:700}
  .items{margin-top:8px}
  .sum-row{display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:6px 4px}
  .pin-code { background-color: #f0f0f0; padding: 4px 8px; border-radius: 6px; font-family: monospace; font-weight: bold; margin-left: 8px; }
</style>
</head>
<body>
<header class="navbar">
  <div class="navbar-inner">
    <div class="logo-container"><a href="/" class="logo-link"><img src="images/lelefonlogo.png" class="logo" alt=""><h1>Lelefon Gaming</h1></a></div>
    <nav class="right-area">
      <a href="/">Home</a><a href="profile.html">Profile</a>
      <span class="wallet-pill">LF Wallet: <span id="walletAmt">0.00</span> MYR</span>
      <a class="btn ghost" href="cart.html">Cart (<span id="cartCount">0</span>)</a>
      <span id="authArea"><a class="btn primary" href="login.html">Login</a></span>
    </nav>
  </div>
</header>
<main class="wrap">
  <h2>My Orders</h2>
  <div id="orders"><p class="muted">Loading your order history...</p></div>
</main>
<script>
    const API_BASE_URL = 'http://localhost:8787/api';
    const Store = { read: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d; } } };
    const user = Store.read('lf_user');

    if (!user) {
        alert('Please login to view your transactions.');
        location.href = `login.html?r=transaction.html`;
    }

    // --- NAVBAR ---
    async function refreshNavbar() {
        const cart = Store.read('lf_cart', []);
        document.getElementById('cartCount').textContent = cart.reduce((s, i) => s + (i.qty || 1), 0);
        
        if (user) {
            document.getElementById('authArea').innerHTML = `<span class="pill">Hi, ${user.email}</span>`;
            try {
                const response = await fetch(`${API_BASE_URL}/wallet?email=${user.email}`);
                const data = await response.json();
                document.getElementById('walletAmt').textContent = data.balance.toFixed(2) + ' MYR';
            } catch (e) { document.getElementById('walletAmt').textContent = 'Error'; }
        } else {
            document.getElementById('authArea').innerHTML = `<a class="btn primary" href="login.html">Login</a>`;
        }
    }

    // --- ORDER HISTORY ---
    async function loadOrders() {
        const ordersEl = document.getElementById('orders');
        try {
            const response = await fetch(`${API_BASE_URL}/orders?email=${user.email}`);
            const orders = await response.json();

            if (orders.length > 0) {
                // NOTE: For simplicity, this view doesn't show individual order items.
                // A more advanced version would fetch items for each order.
                ordersEl.innerHTML = orders.map(order => `
                    <div class="order card" data-id="${order.id}">
                      <div class="head">
                        <div>
                          <strong>Order #${order.id}</strong>
                          <div class="muted">${new Date(order.created_at).toLocaleString()}</div>
                          <div class="muted">Method: ${order.payment_method}</div>
                        </div>
                        <div class="status status-${order.status.toLowerCase()}">${order.status}</div>
                      </div>
                      <div class="items">
                        <div class="sum-row" style="font-weight:800">
                            <span>Total</span>
                            <span>${order.total.toFixed(2)} MYR</span>
                        </div>
                      </div>
                    </div>
                `).join('');
            } else {
                ordersEl.innerHTML = '<p class="muted">You have not placed any orders yet.</p>';
            }
        } catch (e) {
            console.error('Failed to load orders', e);
            ordersEl.innerHTML = '<p class="muted">Could not load your order history. Please try again later.</p>';
        }
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
        refreshNavbar();
        loadOrders();
    });
</script>
</body>
</html>