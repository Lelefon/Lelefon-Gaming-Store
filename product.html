<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Lelefon • Product</title>
<link rel="icon" type="image/png" href="images/lelefonlogo2.png?v=2" sizes="192x192">
<link rel="stylesheet" href="homestyle.css"/>
<style>
  .wrap{width:min(1100px,92vw);margin:24px auto}
  .grid{display:grid;grid-template-columns:1fr;gap:18px}
  @media (min-width:900px){.grid{grid-template-columns:2fr 1fr}}
  .product-head{display:flex;gap:18px;align-items:center;margin:8px 0 18px}
  .thumb{position:relative}
  .product-head img{width:72px;height:72px;border-radius:14px;border:1px solid #eee;object-fit:cover}
  .badge{display:inline-flex;gap:8px;align-items:center;padding:4px 10px;border:1px solid #e6e6e6;border-radius:999px;font-weight:700;margin-left:8px}
  .chip{display:inline-block;padding:4px 10px;border-radius:8px;font-weight:800;color:#fff;font-size:.74rem;margin-right:8px}
  .chip-uid{background:#16a34a}
  .chip-code{background:#ea8a00}

  .pkg-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  @media (min-width:600px){.pkg-grid{grid-template-columns:repeat(3,1fr)}}
  .pkg{border:1px solid #e6e6e6;border-radius:12px;padding:14px;background:#fff;cursor:pointer;text-align:left;transition:all .2s ease}
  .pkg.active{outline:2px solid var(--brand);border-color:var(--brand)}
  .card{border:1px solid #e6e6e6;border-radius:12px;background:#fff;padding:14px}
  .qty{display:flex;align-items:center;gap:8px}
  .qty input{width:72px;text-align:center}

  .price-row{display:flex;justify-content:space-between;align-items:center;margin-top:8px;font-weight:800}
  .price-old{opacity:.65;text-decoration:line-through;margin-right:8px}
  .price-new{font-weight:900}
  .price-line{display:flex;gap:8px;align-items:center;margin-top:6px}
  .tag-off{font-size:.72rem;font-weight:800;color:#0ea5e9;background:#eaf6ff;border-radius:6px;padding:2px 6px}

  /* OUT OF STOCK STYLING */
  .pkg.disabled {
    opacity: 0.5; /* Greys out the card */
    background-color: #f5f5f5;
    pointer-events: none; /* Prevents selection */
    cursor: not-allowed;
    border-color: #ddd;
  }

  input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input[type=number]{-moz-appearance:textfield}
</style>
</head>
<body>
<header class="navbar">
  <div class="navbar-inner">
    <div class="logo-container"><a href="index.html" class="logo-link"><img src="images/lelefonlogo.png" class="logo" alt=""><h1>Lelefon Gaming</h1></a></div>
    <nav class="right-area">
      <a href="index.html">Home</a><a href="transaction.html">Transactions</a><a href="profile.html">Profile</a>
      <span class="wallet-pill">LF Wallet: <span id="walletAmt">0.00</span> MYR</span>
      <a class="btn ghost" href="cart.html">Cart (<span id="cartCount">0</span>)</a>
      <span id="authArea"><a class="btn primary" href="login.html">Login</a></span>
    </nav>
  </div>
</header>

<main class="wrap">
  <div class="crumbs"><a href="index.html">Home</a> / <a href="index.html#topup">Top-Up</a> / <span id="crumbGame">Game</span></div>

  <div class="product-head">
    <div class="thumb"><img id="gameImg" src="images/lelefonlogo2.png" alt=""></div>
    <div class="product-title">
      <h2 id="titleText">Game</h2>
      <div class="muted">Choose a package, enter your details, then Add to Cart or Buy Now.</div>
      <div style="margin-top:8px">
        <span id="modeChip" class="chip chip-uid">UID</span>
        <span id="regionBadge" class="badge" style="display:none"></span>
      </div>
    </div>
  </div>

  <div class="grid">
    <section><div class="pkg-grid" id="pkgGrid"><p class="muted">Loading packages...</p></div></section>
    <aside>
      <div class="card">
        <div id="uidField" style="display:none" class="field"><label><strong>User ID</strong></label><input id="uidInput" placeholder="Enter User ID"/></div>
        <div class="field"><label><strong>Quantity</strong></label><div class="qty"><button id="qMinus" class="btn ghost">–</button><input id="qtyInput" type="number" min="1" value="1"/><button id="qPlus" class="btn ghost">+</button></div></div>
        <div class="price-row"><span>Total</span><span id="totalPrice">0.00 MYR</span></div>
        <div style="display:flex;gap:10px;margin-top:10px"><button id="addCart" class="btn ghost">Add to Cart</button><button id="buyNow" class="btn primary">Buy Now</button></div>
      </div>
    </aside>
  </div>
</main>

<script>
  const API_BASE_URL = 'https://api.lelefon-67.workers.dev/api';
  const Store={read:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},write:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
  const user = Store.read('lf_user');

  function effPrice(pkg){
    const p = Number(pkg.price||0);
    const d = Number(pkg.discount_pct||0);
    if(d>0) return +(p * (1 - d/100)).toFixed(2);
    return +p.toFixed(2);
  }

  async function refreshNavbar(){
    const cart = Store.read('lf_cart', []);
    document.getElementById('cartCount').textContent = cart.reduce((s,i)=>s+(i.qty||1),0);
    if(user){
      document.getElementById('authArea').innerHTML = `<span class="pill">Hi, ${user.email}</span>`;
      try{
        const r = await fetch(`${API_BASE_URL}/wallet?email=${user.email}`);
        const d = await r.json();
        document.getElementById('walletAmt').textContent = Number(d.balance||0).toFixed(2)+' MYR';
      }catch{ document.getElementById('walletAmt').textContent='Error'; }
    }else{
      document.getElementById('authArea').innerHTML = `<a class="btn primary" href="login.html">Login</a>`;
      document.getElementById('walletAmt').textContent='0.00 MYR';
    }
  }

  const params = new URLSearchParams(location.search);
  const gameId   = params.get('game');
  const gameName = decodeURIComponent(params.get('name'));
  const regionKey= params.get('region');
  const needsUID = params.get('uid') === '1';
  const category = params.get('cat') || 'direct';

  document.getElementById('crumbGame').textContent = gameName;
  document.getElementById('titleText').innerHTML = gameName;
  document.getElementById('modeChip').textContent = (category==='card'?'CODE':'UID');
  document.getElementById('modeChip').className = 'chip ' + (category==='card'?'chip-code':'chip-uid');
  if (regionKey) { const rb=document.getElementById('regionBadge'); rb.style.display='inline-flex'; rb.textContent = 'Region: ' + regionKey; }
  if (needsUID) document.getElementById('uidField').style.display = 'block';

  (async ()=>{ try{
    const r = await fetch(`${API_BASE_URL}/games`);
    const games = await r.json();
    const g = games.find(x=>String(x.id)===String(gameId));
    if (g) document.getElementById('gameImg').src = g.image_url;
  }catch{} })();

  let selectedPackage=null;
  const qtyEl = document.getElementById('qtyInput');

  async function loadPackages(){
    const grid = document.getElementById('pkgGrid');
    try{
      const r = await fetch(`${API_BASE_URL}/packages?gameId=${gameId}&regionKey=${regionKey||''}`);
      const pkgs = await r.json();
      if (pkgs.length>0){
        grid.innerHTML = pkgs.map(pkg=>{
          const d = Number(pkg.discount_pct||0);
          const base = Number(pkg.price).toFixed(2);
          const after = effPrice(pkg).toFixed(2);
          
          // Stock Logic
          const stock = (pkg.stock !== undefined && pkg.stock !== null) ? Number(pkg.stock) : 999;
          const isOOS = stock <= 0;
          const disabledClass = isOOS ? 'disabled' : '';
          const clickAction = isOOS ? '' : `selectPackage(this, ${JSON.stringify(pkg).replace(/'/g,"&apos;")})`;
          
          // Determine status text
          let statusLine = '';
          if (isOOS) {
            statusLine = '<div style="color:#ef4444; font-weight:800; font-size:0.85rem; margin-top:6px; text-transform:uppercase;">Out of Stock</div>';
          } else if (stock < 10) {
            statusLine = `<div style="font-size:0.75rem; color:#d97706; margin-top:4px;">Only ${stock} left!</div>`;
          }

          return `
          <div class="pkg ${disabledClass}" onclick='${clickAction}'>
            <strong>${pkg.label}</strong>
            <div class="price-line">
              ${d>0 ? `<span class="price-old">RM ${base}</span>` : ``}
              <span class="price-new">RM ${after}</span>
              ${d>0 ? `<span class="tag-off">-${d}%</span>` : ``}
            </div>
            ${statusLine}
          </div>`;
        }).join('');
      }else{
        grid.innerHTML = '<p class="muted">No packages are available for this selection yet.</p>';
      }
    }catch(e){
      console.error(e);
      grid.innerHTML = '<p class="muted">Could not load packages.</p>';
    }
  }

  function selectPackage(el,pkg){
    document.querySelectorAll('.pkg.active').forEach(x=>x.classList.remove('active'));
    el.classList.add('active'); selectedPackage=pkg; updateTotal();
  }
  function updateTotal(){
    const q = parseInt(qtyEl.value)||1;
    const p = selectedPackage?effPrice(selectedPackage):0;
    document.getElementById('totalPrice').textContent = (p*q).toFixed(2)+' MYR';
  }
  document.getElementById('qMinus').onclick=()=>{ qtyEl.value=Math.max(1,(parseInt(qtyEl.value)||1)-1); updateTotal(); };
  document.getElementById('qPlus').onclick =()=>{ qtyEl.value=(parseInt(qtyEl.value)||1)+1; updateTotal(); };
  qtyEl.oninput = updateTotal;

  function handlePurchase(isBuyNow){
    if(!selectedPackage) return alert('Please select a package.');
    
    // Client-side Stock Check
    const currentStock = (selectedPackage.stock !== undefined) ? selectedPackage.stock : 999;
    const qty = parseInt(qtyEl.value)||1;
    if(qty > currentStock) return alert(`Sorry, only ${currentStock} units available.`);

    if(needsUID && !document.getElementById('uidInput').value.trim()) return alert('Please enter your User ID.');

    const unitPrice = effPrice(selectedPackage);
    const item = {
      key: Date.now().toString(36),
      gameName: gameName,
      pkgLabel: selectedPackage.label,
      price: unitPrice,               // use discounted price in cart/checkout
      qty: qty,
      uid: needsUID ? document.getElementById('uidInput').value.trim() : null
    };

    if(isBuyNow){
      if(!user){ alert('Please login to buy now.'); location.href=`login.html?r=${encodeURIComponent(location.href)}`; return; }
      Store.write('lf_pending',[item]);
      location.href='checkout.html?mode=pending';
    }else{
      const cart = Store.read('lf_cart',[]);
      cart.push(item); Store.write('lf_cart',cart);
      alert(`'${item.pkgLabel}' has been added to your cart.`);
      refreshNavbar();
    }
  }

  document.getElementById('addCart').onclick = ()=>handlePurchase(false);
  document.getElementById('buyNow').onclick  = ()=>handlePurchase(true);

  document.addEventListener('DOMContentLoaded', ()=>{ refreshNavbar(); loadPackages(); });
</script>
</body>
</html>