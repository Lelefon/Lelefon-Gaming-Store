<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Lelefon • Payment</title>
<link rel="icon" type="image/png" href="images/lelefonlogo2.png?v=2" sizes="192x192">
<link rel="stylesheet" href="homestyle.css"/>
<style>
  .wrap{width:min(1100px,92vw);margin:24px auto}
  .layout{display:grid;grid-template-columns:1fr;gap:18px}
  @media (min-width:900px){.layout{grid-template-columns:1.4fr 1fr}}

  .card{border:1px solid #e6e6e6;border-radius:12px;background:#fff;padding:14px}
  .stage{display:flex;gap:12px;margin:6px 0 14px}
  .stage div{padding:6px 10px;border-radius:999px;border:1px solid #e6e6e6}
  .stage .on{background:#111;color:#fff;border-color:#111}

  .sum-row{display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:8px 4px}
  .total{display:flex;justify-content:space-between;font-weight:800;margin-top:10px}

  .pay-choice{display:flex;align-items:center;gap:10px;border:1px solid #e6e6e6;border-radius:10px;padding:12px;background:#fff;cursor:pointer;margin-bottom:10px;transition:.15s ease}
  .pay-choice:hover{box-shadow:0 2px 12px rgba(0,0,0,.06)}
  .pay-choice input{pointer-events:none}
  .pay-choice.active{outline:2px solid #111}

  .pm-extra{margin:8px 0 0 32px;display:none}
  .pm-extra.show{display:block}

  .muted{opacity:.66}

  /* Simulated iPay88 modal */
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
  .overlay .panel{width:min(520px,92vw);background:#fff;border-radius:16px;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,.25)}
  .loader{width:22px;height:22px;border-radius:50%;border:3px solid #ddd;border-top-color:#111;animation:spin 1s linear infinite;margin-right:8px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .bank-select{width:100%;padding:10px;border:1px solid #e6e6e6;border-radius:8px}
</style>
</head>
<body>
<header class="navbar">
  <div class="navbar-inner">
    <div class="logo-container"><a href="/" class="logo-link"><img src="images/lelefonlogo.png" class="logo" alt=""><h1>Lelefon Gaming</h1></a></div>
    <nav class="right-area">
      <a href="/">Home</a><a href="transaction.html">Transactions</a><a href="profile.html">Profile</a>
      <span class="wallet-pill">LF Wallet: <span id="walletAmt">0.00</span> MYR</span>
      <a class="btn ghost" href="cart.html">Cart (<span id="cartCount">0</span>)</a>
      <span id="authArea"><a class="btn primary" href="login.html">Login</a></span>
    </nav>
  </div>
</header>

<main class="wrap">
  <h2>Payment</h2>
  <div class="stage"><div class="on">Order Placed</div><div>Processing</div><div>Completed</div></div>

  <div class="layout">
    <section class="card">
      <h3>Order Summary</h3>
      <div id="summary"></div>
      <div class="total"><span>Payable</span><span id="payable">0.00 MYR</span></div>
    </section>

    <aside class="card">
      <h3>Payment Methods</h3>

      <!-- LF WALLET -->
      <label id="pmWallet" class="pay-choice active" data-method="wallet" aria-label="LF Wallet">
        <input type="radio" name="pm" checked/>
        <div>
          <div><strong>LF Wallet</strong> — Balance <strong id="bal">0.00 MYR</strong></div>
          <div class="muted" style="margin-top:2px">Instant payment from your Lelefon balance.</div>
        </div>
      </label>

      <!-- iPay88 (SIMULATED) -->
      <label id="pmIpay" class="pay-choice" data-method="ipay88" aria-label="iPay88">
        <input type="radio" name="pm"/>
        <div>
          <div><strong>iPay88</strong> — FPX / eWallet / Cards</div>
          <div class="muted" style="margin-top:2px">Simulated now — real gateway can be attached later.</div>
        </div>
      </label>
      <div id="ipayExtra" class="pm-extra" aria-live="polite">
        <label class="muted" style="display:block;margin-bottom:6px">Choose a bank / wallet</label>
        <select id="ipayChannel" class="bank-select">
          <option value="fpx">FPX (Online Banking)</option>
          <option value="tng">Touch ’n Go eWallet</option>
          <option value="boost">Boost</option>
          <option value="grabpay">GrabPay</option>
          <option value="card">Credit / Debit Card</option>
        </select>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <a href="cart.html" class="btn ghost">Back</a>
        <span style="flex:1"></span>
        <button id="payNow" class="btn primary">Pay Now</button>
      </div>
    </aside>
  </div>
</main>

<!-- Simulated iPay88 redirect overlay -->
<div id="redirectOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Connecting to iPay88">
  <div class="panel">
    <div style="display:flex;align-items:center">
      <div class="loader" aria-hidden="true"></div>
      <div>
        <div style="font-weight:800">Connecting to iPay88…</div>
        <div class="muted" id="redirMsg">Please wait while we redirect you to your selected channel.</div>
      </div>
    </div>
  </div>
</div>

<script>
  const API_BASE_URL = 'https://api.lelefon-67.workers.dev/api';
  const Store = { read:(k,d)=>{ try{return JSON.parse(localStorage.getItem(k))??d}catch{return d;} }, write:(k,v)=>localStorage.setItem(k,JSON.stringify(v)) };

  // ---- Auth / navbar ----
  const user = Store.read('lf_user');
  if (!user) { alert('Please login to continue.'); location.href = `login.html?r=checkout.html`; }

  const cartLS = Store.read('lf_cart', []);
  const pendingLS = Store.read('lf_pending', []);
  const mode = new URLSearchParams(location.search).get('mode'); // 'cart' or 'pending'
  const items = (mode === 'pending') ? pendingLS : cartLS;

  const summaryEl = document.getElementById('summary');
  const payableEl = document.getElementById('payable');
  const balanceEl = document.getElementById('bal');
  const walletPillAmt = document.getElementById('walletAmt');
  const cartCount = document.getElementById('cartCount');

  const total = items.reduce((sum, item)=> sum + (item.price * item.qty), 0);

  function refreshNavbarBasics(){
    document.getElementById('authArea').innerHTML = `<span class="pill">Hi, ${user.email}</span>`;
    cartCount.textContent = cartLS.reduce((s,i)=>s+(i.qty||1),0);
  }

  async function loadWallet() {
    try {
      const res = await fetch(`${API_BASE_URL}/wallet?email=${encodeURIComponent(user.email)}`);
      const data = await res.json();
      balanceEl.textContent = data.balance.toFixed(2) + ' MYR';
      walletPillAmt.textContent = data.balance.toFixed(2);
    } catch (e) {
      balanceEl.textContent = 'Error';
    }
  }

  // Render summary
  summaryEl.innerHTML = items.map(i => `
    <div class="sum-row">
      <div>
        <strong>${i.gameName}</strong> — ${i.pkgLabel} ${i.uid ? `• UID: ${i.uid}`: ''}
        <div class="muted">Qty: ${i.qty}</div>
      </div>
      <div><strong>${(i.price * i.qty).toFixed(2)} MYR</strong></div>
    </div>
  `).join('');
  payableEl.textContent = total.toFixed(2) + ' MYR';

  // ---- Payment method selection ----
  const pmWallet = document.getElementById('pmWallet');
  const pmIpay = document.getElementById('pmIpay');
  const ipayExtra = document.getElementById('ipayExtra');
  let selectedMethod = 'wallet';

  function selectMethod(which){
    selectedMethod = which;
    [pmWallet, pmIpay].forEach(el => el.classList.remove('active'));
    if (which === 'wallet'){
      pmWallet.classList.add('active');
      pmWallet.querySelector('input').checked = true;
      ipayExtra.classList.remove('show');
    } else {
      pmIpay.classList.add('active');
      pmIpay.querySelector('input').checked = true;
      ipayExtra.classList.add('show');
    }
  }
  pmWallet.addEventListener('click', ()=>selectMethod('wallet'));
  pmIpay.addEventListener('click', ()=>selectMethod('ipay88'));

  // ---- Payment action ----
  const payBtn = document.getElementById('payNow');
  const overlay = document.getElementById('redirectOverlay');
  const redirMsg = document.getElementById('redirMsg');

  async function createOrder(payload){
    const response = await fetch(`${API_BASE_URL}/orders`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const result = await response.json();
    if (!response.ok || !result.success) throw new Error(result.message || 'Order failed.');
    return result;
  }

  function clearLocalAfterPay(){
    if (mode === 'pending') Store.write('lf_pending', []);
    else Store.write('lf_cart', []);
  }

  payBtn.onclick = async () => {
    if (!items.length){ alert('Your order is empty.'); return; }

    payBtn.disabled = true; payBtn.textContent = 'Processing…';

    try{
      if (selectedMethod === 'wallet'){
        // Wallet flow
        const result = await createOrder({
          user_email: user.email,
          items,
          total,
          method: 'LF Wallet'
        });

        alert(`Payment successful! Your Order ID is ${result.orderId}`);
        clearLocalAfterPay();
        // keep UX snappy by updating pill if balance returned
        if (typeof result.balance === 'number') walletPillAmt.textContent = result.balance.toFixed(2);
        location.href = 'transaction.html';
        return;
      }

      // ---- Simulated iPay88 flow ----
      overlay.style.display = 'flex';
      redirMsg.textContent = 'Please wait while we redirect you to your selected channel.';
      const channel = document.getElementById('ipayChannel').value;

      // Simulated “redirect + confirmation”
      await new Promise(r => setTimeout(r, 1400));
      redirMsg.textContent = 'Awaiting bank / wallet confirmation…';
      await new Promise(r => setTimeout(r, 1800));
      overlay.style.display = 'none';

      const result = await createOrder({
        user_email: user.email,
        items,
        total,
        method: 'iPay88',
        channel
      });

      alert(`Payment successful via iPay88! Order ID: ${result.orderId}`);
      clearLocalAfterPay();
      location.href = 'transaction.html';
    }catch(err){
      overlay.style.display = 'none';
      // Show clearer message for insufficient balance
      if (String(err.message).toLowerCase().includes('insufficient')) {
        alert('Insufficient wallet balance. Please top up your LF Wallet or choose iPay88.');
      } else {
        alert(`Error: ${err.message}`);
      }
      payBtn.disabled = false; payBtn.textContent = 'Pay Now';
    }
  };

  // Init
  (function init(){
    refreshNavbarBasics();
    loadWallet();
  })();
</script>
</body>
</html>
