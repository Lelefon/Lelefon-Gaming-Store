<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Lelefon • Payment</title>
<link rel="icon" type="image/png" href="images/lelefonlogo2.png?v=2" sizes="192x192">
<link rel="stylesheet" href="homestyle.css"/>
<style>
  .wrap{width:min(1100px,92vw);margin:24px auto}
  .layout{display:grid;grid-template-columns:1fr;gap:18px} /* Mobile: 1 column */
  @media (min-width:900px){.layout{grid-template-columns:1.4fr 1fr}} /* Desktop: 2 columns */

  .card{border:1px solid #e6e6e6;border-radius:12px;background:#fff;padding:14px}
  .stage{display:flex;gap:12px;margin:6px 0 14px}
  .stage div{padding:6px 10px;border-radius:999px;border:1px solid #e6e6e6}
  .stage .on{background:#111;color:#fff;border-color:#111}
  .sum-row{display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:8px 4px}
  .total{display:flex;justify-content:space-between;font-weight:800;margin-top:10px}
  .pay-choice{display:flex;align-items:center;gap:10px;border:1px solid #e6e6e6;border-radius:10px;padding:12px;background:#fff;cursor:pointer;margin-bottom:8px}
  .pay-choice.active{outline:2px solid #111}
</style>
</head>
<body>
<header class="navbar">
  <div class="navbar-inner">
    <div class="logo-container"><a href="/" class="logo-link"><img src="images/lelefonlogo.png" class="logo" alt=""><h1>Lelefon Gaming</h1></a></div>
    <nav class="right-area">
      <a href="/">Home</a><a href="transaction.html">Transactions</a><a href="profile.html">Profile</a>
      <span class="wallet-pill">LF Wallet: <span id="walletAmt">0.00</span> MYR</span>
      <a class="btn ghost" href="cart.html">Cart (<span id="cartCount">0</span>)</a>
      <span id="authArea"><a class="btn primary" href="login.html">Login</a></span>
    </nav>
  </div>
</header>
<main class="wrap">
  <h2>Payment</h2>
  <div class="stage"><div class="on">Order Placed</div><div>Processing</div><div>Completed</div></div>
  <div class="layout">
    <section class="card">
      <h3>Order Summary</h3>
      <div id="summary"></div>
      <div class="total"><span>Payable</span><span id="payable">0.00 MYR</span></div>
    </section>
    <aside class="card">
      <h3>Payment Methods</h3>
      <div id="pmWallet" class="pay-choice active" data-method="wallet">
        <input type="radio" name="pm" checked/><strong>LF Wallet</strong> — Balance <strong id="bal">0.00 MYR</strong>
      </div>
      <!-- For simplicity, other payment methods are disabled in this version -->
      <div id="pmFPX" class="pay-choice" data-method="fpx" style="display:none;">
        <input type="radio" name="pm"/><strong>iPay88 (FPX, e-Wallet...)</strong>
      </div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <a href="cart.html" class="btn ghost">Back</a><span style="flex:1"></span><button id="payNow" class="btn primary">Pay Now</button>
      </div>
    </aside>
  </div>
</main>
<script>
    const API_BASE_URL = 'http://localhost:8787/api';
    const Store = {
        read: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d; } },
        write: (k, v) => localStorage.setItem(k, JSON.stringify(v))
    };

    const user = Store.read('lf_user');
    // Redirect to login if user is not logged in
    if (!user) {
        alert('Please login to continue.');
        location.href = `login.html?r=checkout.html`;
    }

    // Determine items from cart or a direct "Buy Now"
    const mode = new URLSearchParams(location.search).get('mode');
    const items = (mode === 'pending') ? Store.read('lf_pending', []) : Store.read('lf_cart', []);
    
    const summaryEl = document.getElementById('summary');
    const payableEl = document.getElementById('payable');
    const balanceEl = document.getElementById('bal');

    const total = items.reduce((sum, item) => sum + (item.price * item.qty), 0);
    
    summaryEl.innerHTML = items.map(i => 
        `<div class="sum-row">
            <div><strong>${i.gameName}</strong> — ${i.pkgLabel} ${i.uid ? `• UID: ${i.uid}`: ''}<div class="muted">Qty: ${i.qty}</div></div>
            <div><strong>${(i.price * i.qty).toFixed(2)} MYR</strong></div>
        </div>`
    ).join('');
    payableEl.textContent = total.toFixed(2) + ' MYR';

    async function loadWallet() {
        try {
            const response = await fetch(`${API_BASE_URL}/wallet?email=${user.email}`);
            const data = await response.json();
            balanceEl.textContent = data.balance.toFixed(2) + ' MYR';
        } catch (e) {
            balanceEl.textContent = 'Error';
        }
    }

    document.getElementById('payNow').onclick = async () => {
        const payButton = document.getElementById('payNow');
        payButton.disabled = true;
        payButton.textContent = 'Processing...';

        try {
            const response = await fetch(`${API_BASE_URL}/orders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_email: user.email,
                    items: items,
                    total: total,
                    method: 'LF Wallet' // Only wallet payment is supported in this version
                })
            });

            const result = await response.json();

            if (response.ok) {
                alert(`Payment successful! Your Order ID is ${result.orderId}`);
                // Clear the temporary cart/pending items from localStorage
                if (mode === 'pending') {
                    Store.write('lf_pending', []);
                } else {
                    Store.write('lf_cart', []);
                }
                location.href = 'transaction.html';
            } else {
                // Throw an error to be caught by the catch block
                throw new Error(result.message || 'Payment failed due to an unknown error.');
            }
        } catch (error) {
            alert(`Error: ${error.message}`);
            payButton.disabled = false;
            payButton.textContent = 'Pay Now';
        }
    };

    // Initial Load
    document.addEventListener('DOMContentLoaded', () => {
        loadWallet();
    });
</script>
</body>
</html>