<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Lelefon • Payment</title>
<link rel="icon" type="image/png" href="images/lelefonlogo2.png?v=2" sizes="192x192">
<link rel="stylesheet" href="homestyle.css"/>
<style>
  .wrap{width:min(1100px,92vw);margin:24px auto}
  .layout{display:grid;grid-template-columns:1fr;gap:18px} /* Mobile: 1 column */
  @media (min-width:900px){.layout{grid-template-columns:1.4fr 1fr}} /* Desktop: 2 columns */

  .card{border:1px solid #e6e6e6;border-radius:12px;background:#fff;padding:14px}
  .stage{display:flex;gap:12px;margin:6px 0 14px}
  .stage div{padding:6px 10px;border-radius:999px;border:1px solid #e6e6e6}
  .stage .on{background:#111;color:#fff;border-color:#111}
  .sum-row{display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:8px 4px}
  .total{display:flex;justify-content:space-between;font-weight:800;margin-top:10px}
  .pay-choice{display:flex;align-items:center;gap:10px;border:1px solid #e6e6e6;border-radius:10px;padding:12px;background:#fff;cursor:pointer;margin-bottom:8px}
  .pay-choice.active{outline:2px solid #111}
</style>
</head>
<body>
<header class="navbar">
  <div class="navbar-inner">
    <div class="logo-container"><a href="/" class="logo-link"><img src="images/lelefonlogo.png" class="logo" alt=""><h1>Lelefon Gaming</h1></a></div>
    <nav class="right-area">
      <a href="/">Home</a><a href="transaction.html">Transactions</a><a href="profile.html">Profile</a>
      <span class="wallet-pill">LF Wallet: <span id="walletAmt">0.00</span> MYR</span>
      <a class="btn ghost" href="cart.html">Cart (<span id="cartCount">0</span>)</a>
      <span id="authArea"><a class="btn primary" href="login.html">Login</a></span>
    </nav>
  </div>
</header>
<main class="wrap">
  <h2>Payment</h2>
  <div class="stage"><div class="on">Order Placed</div><div>Processing</div><div>Completed</div></div>
  <div class="layout">
    <section class="card">
      <h3>Order Summary</h3>
      <div id="summary"></div>
      <div class="total"><span>Payable</span><span id="payable">0.00 MYR</span></div>
    </section>
    <aside class="card">
      <h3>Payment Methods</h3>
      <div id="pmWallet" class="pay-choice" data-method="wallet"><input type="radio" name="pm"/><strong>LF Account</strong> — Balance <strong id="bal">0.00 MYR</strong></div>
      <div id="pmFPX" class="pay-choice" data-method="fpx"><input type="radio" name="pm"/><strong>iPay88 (FPX, e-Wallet...)</strong></div>
      <div style="display:flex;gap:10px;margin-top:12px">
        <a href="cart.html" class="btn ghost">Back</a><span style="flex:1"></span><button id="payNow" class="btn primary">Pay Now</button>
      </div>
    </aside>
  </div>
</main>
<script>
const Store={read:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},write:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};
const state={user:Store.read('lf_user',null),wallets:Store.read('lf_wallets',{}),cart:Store.read('lf_cart',[]),pending:Store.read('lf_pending',null),orders:Store.read('lf_orders',[]),walletLogs:Store.read('lf_wallet_logs',[])};

function save(){
    Store.write('lf_wallets',state.wallets);
    Store.write('lf_cart',state.cart);
    Store.write('lf_orders',state.orders);
    Store.write('lf_wallet_logs',state.walletLogs);
    Store.write('lf_pending',state.pending);
    refresh();
}

function refresh(){
    const userBalance = state.user ? (state.wallets[state.user.email] || 0) : 0;
    document.getElementById('walletAmt').textContent = userBalance.toFixed(2);
    document.getElementById('cartCount').textContent=state.cart.reduce((s,i)=>s+(i.qty||1),0);
    if(state.user)document.getElementById('authArea').innerHTML=`<span class="pill">Hi, ${state.user.email}</span>`;
}
refresh();

const mode=new URLSearchParams(location.search).get('mode')||'cart';
let items = (mode==='pending' && state.pending)? state.pending.slice() : state.cart.slice();

const summary=document.getElementById('summary'), payable=document.getElementById('payable'), bal=document.getElementById('bal');
const currentUserBalance = state.user ? (state.wallets[state.user.email] || 0) : 0;
bal.textContent = currentUserBalance.toFixed(2) + ' MYR';

function total(){return items.reduce((s,i)=>s+i.price*i.qty,0)}
function draw(){ summary.innerHTML=items.map(i=>`<div class="sum-row"><div><strong>${i.gameName}</strong> ${i.region?`(${i.region})`:''} — ${i.pkgLabel} ${i.uid?`• UID: ${i.uid}`:''}<div class="muted">Qty: ${i.qty}</div></div><div><strong>${(i.price*i.qty).toFixed(2)} MYR</strong></div></div>`).join(''); payable.textContent=total().toFixed(2)+' MYR'; }
draw();

let payMethod='wallet';
['pmWallet','pmFPX'].forEach(id=>{
  const el=document.getElementById(id);
  el.onclick=()=>{ document.querySelectorAll('.pay-choice').forEach(x=>x.classList.remove('active')); el.classList.add('active'); payMethod=el.dataset.method; };
});
document.getElementById('pmWallet').classList.add('active');

function pushOrder(orderId, method, initialStatus){
  const now=Date.now();
  const order={ id:orderId, user:state.user?.email||'guest', items, total:total(), method, status: initialStatus, createdAt:now, paidAt: (initialStatus === 'Processing' ? now : null) };
  state.orders.unshift(order);
  if(mode==='cart'){ state.cart=[]; }
  state.pending=null;
}

document.getElementById('payNow').onclick = async () => {
    if (!state.user) {
        alert('Please login to continue.');
        location.href = 'login.html';
        return;
    }

    const amt = total();
    const payNowBtn = document.getElementById('payNow');
    payNowBtn.disabled = true;
    payNowBtn.textContent = 'Processing...';

    if (payMethod === 'wallet') {
        const userEmail = state.user.email;
        const userBalance = state.wallets[userEmail] || 0;

        if (userBalance < amt) {
            alert('Insufficient LF Wallet balance. Please top up.');
            payNowBtn.disabled = false;
            payNowBtn.textContent = 'Pay Now';
            return;
        }
        
        state.wallets[userEmail] -= amt;
        state.walletLogs.unshift({id:'WL'+Date.now().toString(36),type:'purchase',delta:-amt,createdAt:Date.now(),note:`Order purchase by ${userEmail}`});
        
        const orderId = 'LF' + Date.now().toString(36).toUpperCase();
        pushOrder(orderId, 'LF Wallet', 'Processing');
        
        save();
        alert('Payment successful. Order ' + orderId + ' is being processed.');
        location.href = 'transaction.html';
    } else {
        const orderId = 'LF' + Date.now().toString(36).toUpperCase();
        const orderDetails = {
            amount: amt.toFixed(2),
            orderId: orderId,
            userName: state.user.email,
            userEmail: state.user.email
        };

        try {
            pushOrder(orderId, 'iPay88', 'Pending');
            save(); 
            
            const response = await fetch('https://lelefon-ipay88-handler.YOUR_WORKER_SUBDOMAIN.workers.dev', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderDetails)
            });

            if (!response.ok) { throw new Error('Payment server responded with an error.'); }
            
            const paymentData = await response.json();
            
            const form = document.createElement('form');
            form.method = 'post';
            form.action = paymentData.paymentUrl;
            form.style.display = 'none';

            for (const key in paymentData) {
                if (paymentData.hasOwnProperty(key) && key !== 'paymentUrl') {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = paymentData[key];
                    form.appendChild(input);
                }
            }
            document.body.appendChild(form);
            form.submit();

        } catch (error) {
            console.error('Failed to initiate iPay88 payment:', error);
            alert('Could not connect to the payment service. Please try again later.');
            state.orders = state.orders.filter(o => o.id !== orderId);
            save();
            payNowBtn.disabled = false;
            payNowBtn.textContent = 'Pay Now';
        }
    }
};
</script>
</body>
</html>