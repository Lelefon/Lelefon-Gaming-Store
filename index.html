<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lelefon Gaming Store</title>
  <link rel="icon" type="image/png" href="images/lelefonlogo2.png?v=2" sizes="192x192">
  <link rel="stylesheet" href="homestyle.css"/>
  <style>
    /* ======= Homepage specific styles ======= */

    /* Game grid */
    .game-grid{display:grid;gap:14px;grid-template-columns:repeat(2,1fr)}
    @media (min-width:600px){.game-grid{grid-template-columns:repeat(3,1fr)}}
    @media (min-width:900px){.game-grid{grid-template-columns:repeat(5,1fr)}}

    .game-card{cursor:pointer;border:1px solid #1e1e1e;background:#0f0f10;border-radius:16px;overflow:hidden;transition:transform .15s ease, box-shadow .15s ease}
    .game-card:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .game-card .card-inner{position:relative;aspect-ratio:4/3;background:#000}
    .game-card .card-inner img{width:100%;height:100%;object-fit:cover;filter:grayscale(10%)}
    .game-card .tag{position:absolute;left:10px;bottom:10px;font-size:.72rem;font-weight:800;color:#fff;border-radius:6px;padding:6px 10px;letter-spacing:.3px}
    .tag-uid{background:#16a34a}
    .tag-code{background:#ea8a00}
    .game-card .game-title{margin:10px;padding:0;color:#eaeaea;font-weight:700;line-height:1.15}

    /* Modal */
    .modal.hidden{display:none}
    .modal{position:fixed;inset:0;display:grid;place-items:center;z-index:50}
    .modal-backdrop{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(1px)}
    .modal-dialog{position:relative;background:linear-gradient(180deg,#183261,#14284d);color:#fff;width:min(980px,92vw);border-radius:18px;padding:22px 22px 26px;box-shadow:0 18px 40px rgba(0,0,0,.45)}
    .modal-header{display:flex;align-items:center;gap:12px;margin-bottom:6px}
    .modal-header h3{font-size:1.6rem;margin:0}
    .modal-close{position:absolute;right:16px;top:16px;border:0;background:#ffffff14;border-radius:999px;width:36px;height:36px;color:#fff;font-size:20px;cursor:pointer}
    .pill-sm{display:inline-flex;align-items:center;gap:6px;background:#0f1e38;border:1px solid #2a477e;padding:4px 8px;border-radius:999px;font-weight:800;font-size:.72rem}

    /* Region grid + cards (Gamejus-like) */
    .region-grid{display:grid;gap:18px;grid-template-columns:repeat(1,1fr);margin-top:12px}
    @media (min-width:640px){.region-grid{grid-template-columns:repeat(2,1fr)}}
    @media (min-width:900px){.region-grid{grid-template-columns:repeat(3,1fr)}}

    .region-card{cursor:pointer;color:#fff}
    .region-card .thumb{position:relative;aspect-ratio:4/3;border-radius:14px;overflow:hidden;background:#000;box-shadow:0 12px 24px rgba(0,0,0,.35)}
    .region-card img{width:100%;height:100%;object-fit:cover;filter:grayscale(12%)}
    .region-flag{position:absolute;right:10px;top:10px;background:#fff;color:#111;border-radius:999px;width:32px;height:32px;display:grid;place-items:center;font-size:16px;border:1px solid #e8e8e8}
    .region-chip{position:absolute;left:14px;bottom:10px;font-size:.74rem;font-weight:800;color:#fff;border-radius:6px;padding:7px 12px;letter-spacing:.3px}
    .chip-uid{background:#16a34a}
    .chip-code{background:#ea8a00}
    .region-label{margin-top:8px;font-weight:700;line-height:1.2}

    /* Minor */
    .hero h2{margin:0}
  </style>
</head>
<body>
<header class="navbar">
  <div class="navbar-inner">
    <div class="logo-container"><a href="/" class="logo-link"><img src="images/lelefonlogo.png" alt="Lelefon Logo" class="logo"/><h1>Lelefon Gaming</h1></a></div>
    <nav class="right-area">
      <a href="/">Home</a><a href="transaction.html">Transactions</a><a href="profile.html">Profile</a>
      <span class="wallet-pill">LF Wallet: <span id="walletAmt">0.00</span> MYR</span>
      <a class="btn ghost" href="cart.html">Cart (<span id="cartCount">0</span>)</a>
      <span id="authArea"><a class="btn primary" href="login.html">Login</a></span>
    </nav>
  </div>
</header>

<main class="container">
  <section class="hero">
    <h2>Top Up Your Favourite Games Instantly ‚ö°</h2>
    <p>Fast, Secure & Trusted by Gamers.</p>
  </section>

  <section class="games-section" id="topup">
    <h3>Popular Games</h3>
    <div class="filter-bar" role="tablist" aria-label="Filter games">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="direct">Direct Topup</button>
      <button class="filter-btn" data-filter="card">Game Card</button>
    </div>

    <div class="game-grid" id="gameGrid">
      <p class="muted">Loading games from the database...</p>
    </div>
  </section>
</main>

<footer><p>¬© 2025 Lelefon Gaming Store. All Rights Reserved.</p></footer>

<!-- Region Modal -->
<div id="regionModal" class="modal hidden">
  <div class="modal-backdrop" onclick="closeModal()"></div>
  <div class="modal-dialog">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <div class="modal-header">
      <h3 id="modalTitle">Select Server/Region</h3>
    </div>
    <div style="margin:6px 0 10px">
      <span id="modalGameBadge" class="pill-sm"><span id="modalTagChip">UID</span> <span id="modalGameName">Game</span></span>
    </div>
    <div class="region-grid" id="regionGrid"></div>
  </div>
</div>

<script>
  const API_BASE_URL = 'https://api.lelefon-67.workers.dev/api';
  const Store={read:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}};
  const user = Store.read('lf_user');

  /* ---------------- Navbar ---------------- */
  async function refreshNavbar(){
    const cart = Store.read('lf_cart', []);
    document.getElementById('cartCount').textContent = cart.reduce((s,i)=>s+(i.qty||1),0);
    if(user){
      document.getElementById('authArea').innerHTML = `<span class="pill">Hi, ${user.email}</span>`;
      try{
        const r = await fetch(`${API_BASE_URL}/wallet?email=${user.email}`);
        const w = await r.json();
        document.getElementById('walletAmt').textContent = Number(w.balance||0).toFixed(2)+' MYR';
      }catch{ document.getElementById('walletAmt').textContent='Error'; }
    }else{
      document.getElementById('authArea').innerHTML = `<a class="btn primary" href="login.html">Login</a>`;
      document.getElementById('walletAmt').textContent='0.00 MYR';
    }
  }

  /* ---------------- Home: load games ---------------- */
  async function loadGames(){
    const grid = document.getElementById('gameGrid');
    try{
      const r = await fetch(`${API_BASE_URL}/games`);
      const games = await r.json();

      if(!games.length){ grid.innerHTML = '<p class="muted">No games yet. Ask an admin to add some.</p>'; return; }

      grid.innerHTML = games.map(g => `
        <div class="game-card" data-category="${g.category}" onclick='openGame(${JSON.stringify(g).replace(/'/g,"&apos;")})'>
          <div class="card-inner">
            <img src="${g.image_url}" alt="${g.name}" onerror="this.src='images/lelefonlogo2.png'">
            <span class="tag ${g.category==='card'?'tag-code':'tag-uid'}">${g.category==='card'?'CODE':'UID'}</span>
          </div>
          <p class="game-title">${g.name}</p>
        </div>
      `).join('');
    }catch(e){
      console.error(e);
      grid.innerHTML = '<p class="muted">Could not load games.</p>';
    }
  }

  /* ---------------- Region mapping presets ---------------- */
  const FLAG = {
    MY:'üá≤üáæ', ID:'üáÆüá©', PH:'üáµüá≠', TH:'üáπüá≠', BR:'üáßüá∑', SG:'üá∏üá¨', US:'üá∫üá∏', HK:'üá≠üá∞', JP:'üáØüáµ',
    GLOBAL:'üåê', AMERICA:'üåé', ASIA:'üåè', EUROPE:'üá™üá∫', TWHKMO:'üåè'
  };

  // Given a game object, return preset regions or null
  function presetRegionsFor(game){
    const name = (game.name||'').toLowerCase();

    // HoYoverse titles
    if (/(genshin|honkai|zenless)/.test(name)) {
      return [
        {region_key:'America', name:'America', flag:FLAG.AMERICA},
        {region_key:'Asia',    name:'Asia',    flag:FLAG.ASIA},
        {region_key:'Europe',  name:'Europe',  flag:FLAG.EUROPE},
        {region_key:'TWHKMO',  name:'TW,HK,MO',flag:FLAG.TWHKMO},
      ];
    }

    // Nintendo eShop
    if (/nintendo.*shop|eshop/.test(name)) {
      return [
        {region_key:'US', name:'United States', flag:FLAG.US},
        {region_key:'HK', name:'Hong Kong',     flag:FLAG.HK},
        {region_key:'BR', name:'Brazil',        flag:FLAG.BR},
        {region_key:'JP', name:'Japan',         flag:FLAG.JP},
      ];
    }

    // Steam Wallet Code (game card)
    if (/steam.*wallet/.test(name)) {
      return [
        {region_key:'MYR', name:'MYR', flag:FLAG.MY},
        {region_key:'IDR', name:'IDR', flag:FLAG.ID},
        {region_key:'THB', name:'THB', flag:FLAG.TH},
        {region_key:'SGD', name:'SGD', flag:FLAG.SG},
      ];
    }

    // MLBB
    if (/mobile legends/.test(name)) {
      return [
        {region_key:'MY', name:'Malaysia',    flag:FLAG.MY},
        {region_key:'ID', name:'Indonesia',   flag:FLAG.ID},
        {region_key:'PH', name:'Philippine',  flag:FLAG.PH},
        {region_key:'TH', name:'Thailand',    flag:FLAG.TH},
        {region_key:'BR', name:'Brazil',      flag:FLAG.BR},
        {region_key:'GLOBAL', name:'Global',  flag:FLAG.GLOBAL},
      ];
    }

    // Valorant PC
    if (/valorant/.test(name)) {
      return [
        {region_key:'MY', name:'Malaysia',    flag:FLAG.MY},
        {region_key:'ID', name:'Indonesia',   flag:FLAG.ID},
        {region_key:'PH', name:'Philippine',  flag:FLAG.PH},
        {region_key:'TH', name:'Thailand',    flag:FLAG.TH},
      ];
    }

    // Free Fire examples
    if (/free.?fire/.test(name)) {
      return [
        {region_key:'MY',  name:'Malaysia',           flag:FLAG.MY},
        {region_key:'MYI', name:'Malaysia-Instant',   flag:FLAG.MY},
        {region_key:'IDI', name:'Indonesia-Instant',  flag:FLAG.ID},
        {region_key:'GLOBAL', name:'Global',          flag:FLAG.GLOBAL},
      ];
    }

    // PUBG Mobile
    if (/pubg.*mobile/.test(name)) {
      return [{region_key:'GLOBAL', name:'Global', flag:FLAG.GLOBAL}];
    }

    return null; // unknown -> depend on DB/admin
  }

  /* ---------------- Region modal ---------------- */
  function closeModal(){ document.getElementById('regionModal').classList.add('hidden'); }

  async function openGame(game){
    // If game is regionable, show modal; else go straight to product
    if (!game.regionable) { navigateToProduct(game.id, game.name, null, game.uid_required, game.category); return; }

    // Load regions from DB
    let regions = [];
    try{
      const r = await fetch(`${API_BASE_URL}/regions?gameId=${encodeURIComponent(game.id)}`);
      regions = await r.json();
    }catch{ regions = []; }

    // If no regions in DB, try to seed from presets
    if (!regions || regions.length === 0) {
      const preset = presetRegionsFor(game);
      if (preset && Array.isArray(preset)) {
        try {
          // store to DB (your API allows this without auth)
          await Promise.all(preset.map(p =>
            fetch(`${API_BASE_URL}/admin/region`, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body:JSON.stringify({ game_id: game.id, region_key: p.region_key, name: p.name, flag: p.flag })
            })
          ));
          regions = preset;
        } catch (e) {
          console.warn('Preset region insert failed (non-fatal):', e);
          regions = preset; // still show UI
        }
      }
    }

    // Render modal
    document.getElementById('modalTitle').textContent = 'Select Server/Region';
    document.getElementById('modalGameName').textContent = game.name;
    const isCode = game.category === 'card';
    document.getElementById('modalTagChip').textContent = isCode ? 'CODE' : 'UID';

    const grid = document.getElementById('regionGrid');
    if (!regions || regions.length === 0) {
      grid.innerHTML = `<p class="muted">No regions set yet for this title.</p>`;
    } else {
      grid.innerHTML = regions.map(r => `
        <div class="region-card" onclick="navigateToProduct('${game.id}','${encodeURIComponent(game.name)}','${r.region_key}',${game.uid_required},'${game.category}')">
          <div class="thumb">
            <img src="${game.image_url}" alt="${game.name}" onerror="this.src='images/lelefonlogo2.png'">
            <div class="region-flag" title="${r.name}">${r.flag || 'üåê'}</div>
            <div class="region-chip ${isCode ? 'chip-code':'chip-uid'}">${isCode ? 'CODE':'UID'}</div>
          </div>
          <div class="region-label">${game.name} (${r.name})</div>
        </div>
      `).join('');
    }
    document.getElementById('regionModal').classList.remove('hidden');
  }

  function navigateToProduct(gameId, gameNameEncoded, regionKey, uidRequired, category){
    const gameName = decodeURIComponent(gameNameEncoded || '');
    let url = `product.html?game=${encodeURIComponent(gameId)}&name=${encodeURIComponent(gameName)}&uid=${uidRequired?1:0}&cat=${encodeURIComponent(category||'direct')}`;
    if (regionKey) url += `&region=${encodeURIComponent(regionKey)}`;
    location.href = url;
  }

  /* ---------------- Filters ---------------- */
  document.querySelectorAll('.filter-btn').forEach(btn=>{
    btn.onclick = ()=>{
      document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const f = btn.dataset.filter;
      document.querySelectorAll('.game-card').forEach(card=>{
        card.style.display = (f==='all' || card.dataset.category===f) ? 'block' : 'none';
      });
    };
  });

  /* ---------------- Init ---------------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    refreshNavbar();
    loadGames();
  });
</script>
</body>
</html>
