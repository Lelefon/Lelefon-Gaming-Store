<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lelefon Gaming Store</title>
  <link rel="icon" type="image/png" href="images/lelefonlogo2.png?v=2" sizes="192x192">
  <link rel="stylesheet" href="homestyle.css"/>

  <style>
    /* ---------- Layout (unchanged basics) ---------- */
    .game-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
    }
    @media (min-width: 600px) {.game-grid { grid-template-columns: repeat(3, 1fr); }}
    @media (min-width: 900px) {.game-grid { grid-template-columns: repeat(5, 1fr); }}

    .game-card { cursor:pointer; }
    .game-card .card-inner {
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:#fff;
      transition:transform .2s ease, box-shadow .2s ease;
    }
    .game-card:hover .card-inner { transform: translateY(-3px); box-shadow:0 8px 18px rgba(0,0,0,.08);}
    .game-card img { width:100%; height:150px; object-fit:cover; display:block; }
    .game-title { margin:.5rem 0 0; font-weight:700; }

    /* ---------- Modal: modern dark theme ---------- */
    .modal.hidden { display:none; }
    .modal { position:fixed; inset:0; z-index:1000; }
    .modal-backdrop {
      position:absolute; inset:0;
      background:rgba(0,0,0,.45);
      backdrop-filter: blur(4px);
      animation: fadeIn .18s ease-out;
    }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    .modal-dialog {
      position:relative;
      background: linear-gradient(180deg, #0d0d0f 0%, #1a1a1d 100%);
      color:#fff;
      width:min(980px,92vw);
      margin: 40px auto;
      border-radius:20px;
      box-shadow:0 18px 40px rgba(0,0,0,.55);
      padding:28px;
      animation: pop .18s ease-out;
    }
    @keyframes pop { from{ transform: translateY(6px); opacity:.95 } to{ transform: translateY(0); opacity:1 }}

    .modal-header { display:flex; align-items:center; gap:12px; }
    .modal-header h3 { font-size:1.7rem; font-weight:800; letter-spacing:.3px; margin:0; }

    .modal-close {
      position:absolute; top:18px; right:18px;
      width:38px;height:38px;border-radius:999px;
      background:rgba(255,255,255,.08); color:#fff; border:none;
      font-size:22px; cursor:pointer; transition: background .2s ease;
    }
    .modal-close:hover { background: rgba(255,255,255,.18); }

    .pill-muted {
      font-size:.78rem; font-weight:800; letter-spacing:.3px;
      padding:6px 10px; border-radius:999px; background:#1f2937; color:#cbd5e1;
    }

    .region-grid {
      display:grid; gap:24px; margin-top:20px;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    }

    /* ---------- Region card ---------- */
    .region-card {
      position:relative; border-radius:16px; overflow:hidden;
      background:#111; cursor:pointer;
      transition: transform .2s ease, box-shadow .2s ease;
    }
    .region-card:hover { transform: translateY(-4px); box-shadow:0 10px 22px rgba(0,0,0,.45); }

    .region-card .thumb { position:relative; aspect-ratio: 4/3; }
    .region-card img {
      width:100%; height:100%; object-fit:cover; display:block;
      border-radius:16px; transition: filter .25s ease;
    }
    .region-card:hover img { filter: brightness(1.08); }

    .region-overlay {
      position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(0,0,0,.12) 0%, rgba(0,0,0,.72) 100%);
      display:flex; flex-direction:column; justify-content:flex-end;
      padding:10px 12px;
    }

    .region-flag {
      position:absolute; top:10px; right:10px;
      width:36px; height:36px; border-radius:50%;
      background:#fff; color:#000; display:flex; align-items:center; justify-content:center;
      font-size:18px; font-weight:800; box-shadow:0 2px 8px rgba(0,0,0,.4);
      user-select:none;
    }

    .region-chip {
      position:absolute; bottom:10px; left:10px;
      font-size:.75rem; font-weight:800; letter-spacing:.3px;
      padding:6px 12px; border-radius:6px; color:#fff;
      box-shadow: 0 2px 6px rgba(0,0,0,.35);
    }
    .chip-uid { background:#16a34a; }    /* green */
    .chip-code{ background:#ea8a00; }    /* orange */

    .region-label {
      color:#fff; font-weight:800; font-size:.98rem; margin-top:6px; padding-left:4px;
      text-shadow:0 1px 3px rgba(0,0,0,.8);
    }

    /* small filter bar */
    .filter-bar { display:flex; gap:8px; margin:10px 0 18px; }
    .filter-btn { border:1px solid var(--border); background:#fff; border-radius:20px; padding:6px 12px; cursor:pointer; font-weight:700; }
    .filter-btn.active { background:var(--brand); color:#fff; border-color:var(--brand); }
  </style>
</head>

<body>
<header class="navbar">
  <div class="navbar-inner">
    <div class="logo-container">
      <a href="/" class="logo-link">
        <img src="images/lelefonlogo.png" alt="Lelefon Logo" class="logo"/>
        <h1>Lelefon Gaming</h1>
      </a>
    </div>
    <nav class="right-area">
      <a href="/">Home</a>
      <a href="transaction.html">Transactions</a>
      <a href="profile.html">Profile</a>
      <span class="wallet-pill">LF Wallet: <span id="walletAmt">0.00</span> MYR</span>
      <a class="btn ghost" href="cart.html">Cart (<span id="cartCount">0</span>)</a>
      <span id="authArea"><a class="btn primary" href="login.html">Login</a></span>
    </nav>
  </div>
</header>

<main class="container">
  <section class="hero">
    <h2>Top Up Your Favourite Games Instantly ⚡</h2>
    <p>Fast, Secure & Trusted by Gamers.</p>
  </section>

  <section class="games-section" id="topup">
    <h3>Popular Games</h3>

    <div class="filter-bar" role="tablist" aria-label="Filter games">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="direct">Direct Top-Up</button>
      <button class="filter-btn" data-filter="card">Game Card</button>
    </div>

    <div class="game-grid" id="gameGrid">
      <p class="muted">Loading games from the database...</p>
    </div>
  </section>
</main>

<footer><p>© 2025 Lelefon Gaming Store. All Rights Reserved.</p></footer>

<!-- Region Modal -->
<div id="regionModal" class="modal hidden" aria-hidden="true">
  <div class="modal-backdrop" onclick="closeModal()"></div>
  <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <button class="modal-close" onclick="closeModal()" aria-label="Close">×</button>
    <div class="modal-header">
      <h3 id="modalTitle">Select Server/Region</h3>
      <span id="modalGameChip" class="pill-muted"></span>
    </div>
    <div class="region-grid" id="regionGrid"></div>
  </div>
</div>

<script>
  const API_BASE_URL = 'https://api.lelefon-67.workers.dev/api';
  const Store = {
    read: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } },
    write: (k, v) => localStorage.setItem(k, JSON.stringify(v)),
  };
  const user = Store.read('lf_user');

  /* ---------------- Navbar ---------------- */
  async function refreshNavbar() {
    const cart = Store.read('lf_cart', []);
    document.getElementById('cartCount').textContent = cart.reduce((s, i) => s + (i.qty || 1), 0);

    if (user) {
      document.getElementById('authArea').innerHTML = `<span class="pill">Hi, ${user.email}</span>`;
      try {
        const r = await fetch(`${API_BASE_URL}/wallet?email=${encodeURIComponent(user.email)}`);
        const d = await r.json();
        document.getElementById('walletAmt').textContent = Number(d.balance||0).toFixed(2) + ' MYR';
      } catch { document.getElementById('walletAmt').textContent = 'Error'; }
    } else {
      document.getElementById('authArea').innerHTML = `<a class="btn primary" href="login.html">Login</a>`;
      document.getElementById('walletAmt').textContent = '0.00 MYR';
    }
  }

  /* ---------------- Load Games ---------------- */
  async function loadGames() {
    const grid = document.getElementById('gameGrid');
    try {
      const res = await fetch(`${API_BASE_URL}/games`);
      const games = await res.json();

      if (!games.length) {
        grid.innerHTML = '<p class="muted">No games have been added yet. Please ask an admin to add games.</p>';
        return;
      }

      grid.innerHTML = games.map(g => `
        <div class="game-card" data-category="${g.category}" onclick='handleGameClick(${JSON.stringify(g)})'>
          <div class="card-inner">
            <img src="${g.image_url}" alt="${g.name}" onerror="this.src='images/lelefonlogo2.png'">
          </div>
          <p class="game-title">${g.name}</p>
        </div>
      `).join('');
    } catch (e) {
      console.error(e);
      grid.innerHTML = '<p class="muted">Could not load games. Please ensure the backend server is reachable.</p>';
    }
  }

  /* ---------------- Modal / Regions ---------------- */
  function openModal() { document.getElementById('regionModal').classList.remove('hidden'); }
  function closeModal(){ document.getElementById('regionModal').classList.add('hidden'); }

  async function handleGameClick(game) {
    const isCode = game.category === 'card';     // card = code, direct = uid
    document.getElementById('modalTitle').textContent = 'Select Server/Region';
    document.getElementById('modalGameChip').textContent = `${isCode ? 'CODE' : 'UID'}  ${game.name}`;

    if (Number(game.regionable) === 1) {
      try {
        const r = await fetch(`${API_BASE_URL}/regions?gameId=${encodeURIComponent(game.id)}`);
        const regions = await r.json();
        renderRegionGrid(game, regions);
        openModal();
      } catch (e) {
        console.error('Region fetch error', e);
        alert('Could not fetch regions for this game.');
      }
    } else {
      // No regions → go straight to product
      navigateToProduct(game.id, game.name, null, game.uid_required, game.category);
    }
  }

  function renderRegionGrid(game, regions) {
    const grid = document.getElementById('regionGrid');
    const isCode = game.category === 'card';

    if (!regions.length) {
      grid.innerHTML = '<p class="muted">No regions have been added for this game yet.</p>';
      return;
    }

    grid.innerHTML = regions.map(r => `
      <div class="region-card"
           onclick="navigateToProduct('${game.id}','${encodeURIComponent(game.name)}','${r.region_key}',${game.uid_required},'${game.category}')">
        <div class="thumb">
          <img src="${game.image_url}" alt="${game.name}" onerror="this.src='images/lelefonlogo2.png'">
          <div class="region-overlay">
            <div class="region-chip ${isCode ? 'chip-code' : 'chip-uid'}">${isCode ? 'CODE' : 'UID'}</div>
            <div class="region-label">${game.name} (${r.name})</div>
          </div>
          <div class="region-flag" title="${r.name}">${r.flag || '🌐'}</div>
        </div>
      </div>
    `).join('');
  }

  function navigateToProduct(gameId, gameName, regionKey, uidRequired, category) {
    let url = `product.html?game=${encodeURIComponent(gameId)}&name=${encodeURIComponent(gameName)}&uid=${uidRequired}&cat=${encodeURIComponent(category||'direct')}`;
    if (regionKey) url += `&region=${encodeURIComponent(regionKey)}`;
    location.href = url;
  }

  /* ---------------- Filters ---------------- */
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.onclick = () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const filter = btn.dataset.filter; // all | direct | card
      document.querySelectorAll('.game-card').forEach(card => {
        const cat = card.getAttribute('data-category');
        card.style.display = (filter === 'all' || cat === filter) ? 'block' : 'none';
      });
    };
  });

  /* ---------------- Init ---------------- */
  document.addEventListener('DOMContentLoaded', () => {
    refreshNavbar();
    loadGames();
  });
</script>
</body>
</html>
