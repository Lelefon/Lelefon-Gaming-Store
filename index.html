<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lelefon Gaming Store</title>
  <link rel="icon" type="image/png" href="images/lelefonlogo2.png?v=2" sizes="192x192">
  <link rel="stylesheet" href="homestyle.css"/>
  <style>
    /* Additional styles specific to this page */
    .game-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* 2 columns for mobile */
        gap: 14px;
    }
    
    /* Tablet layout */
    @media (min-width: 600px) {
        .game-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    /* Desktop layout */
    @media (min-width: 900px) {
        .game-grid {
            grid-template-columns: repeat(5, 1fr);
        }
    }
  </style>
</head>
<body>
<header class="navbar">
  <div class="navbar-inner">
    <div class="logo-container"><a href="/" class="logo-link"><img src="images/lelefonlogo.png" alt="Lelefon Logo" class="logo"/><h1>Lelefon Gaming</h1></a></div>
    <nav class="right-area">
      <a href="/">Home</a><a href="transaction.html">Transactions</a><a href="profile.html">Profile</a>
      <span class="wallet-pill">LF Wallet: <span id="walletAmt">0.00</span> MYR</span>
      <a class="btn ghost" href="cart.html">Cart (<span id="cartCount">0</span>)</a>
      <span id="authArea"><a class="btn primary" href="login.html">Login</a></span>
    </nav>
  </div>
</header>

<main class="container">
  <section class="hero"><h2>Top Up Your Favourite Games Instantly ‚ö°</h2><p>Fast, Secure & Trusted by Gamers.</p></section>
  <section class="games-section" id="topup">
    <h3>Popular Games</h3>
    <div class="filter-bar" role="tablist" aria-label="Filter games">
      <button class="filter-btn active" data-filter="all">All</button><button class="filter-btn" data-filter="direct">Direct Topup</button><button class="filter-btn" data-filter="card">Game Card</button>
    </div>
    <div class="game-grid" id="gameGrid">
      <p class="muted">Loading games from the database...</p>
    </div>
    <!-- The "View More" button can be removed or hidden as all games will be loaded dynamically -->
    <!-- <button id="viewMoreBtn" class="view-more-btn" aria-expanded="false">View More ‚Üí</button> -->
  </section>
</main>
<footer><p>¬© 2025 Lelefon Gaming Store. All Rights Reserved.</p></footer>

<div id="regionModal" class="modal hidden">
  <div class="modal-backdrop" onclick="closeModal()"></div>
  <div class="modal-dialog">
    <button class="modal-close" onclick="closeModal()">√ó</button>
    <div class="modal-header"><h3 id="modalTitle">Select Server / Region</h3></div>
    <div class="region-grid" id="regionGrid"></div>
  </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:8787/api';
    const Store = { read: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d; } } };
    const user = Store.read('lf_user');

    // --- NAVBAR LOGIC ---
    async function refreshNavbar() {
        const cart = Store.read('lf_cart', []);
        document.getElementById('cartCount').textContent = cart.reduce((s, i) => s + (i.qty || 1), 0);
        
        if (user) {
            document.getElementById('authArea').innerHTML = `<span class="pill">Hi, ${user.email}</span>`;
            try {
                // Fetch wallet balance from the API
                const response = await fetch(`${API_BASE_URL}/wallet?email=${user.email}`);
                if (!response.ok) throw new Error('Failed to fetch wallet');
                const data = await response.json();
                document.getElementById('walletAmt').textContent = data.balance.toFixed(2) + ' MYR';
            } catch (e) {
                console.error('Failed to fetch wallet balance:', e);
                document.getElementById('walletAmt').textContent = 'Error';
            }
        } else {
            document.getElementById('authArea').innerHTML = `<a class="btn primary" href="login.html">Login</a>`;
            document.getElementById('walletAmt').textContent = '0.00 MYR';
        }
    }

    // --- GAME LOADING LOGIC ---
    async function loadGames() {
        const gameGrid = document.getElementById('gameGrid');
        try {
            const response = await fetch(`${API_BASE_URL}/games`);
            if (!response.ok) throw new Error('Server responded with an error');
            const games = await response.json();
            
            if (games.length === 0) {
                gameGrid.innerHTML = '<p class="muted">No games have been added yet. Please ask an admin to add games.</p>';
                return;
            }

            gameGrid.innerHTML = games.map(game => `
                <div class="game-card" data-category="${game.category}" onclick='handleGameClick(${JSON.stringify(game)})'>
                    <div class="card-inner"><img src="${game.image_url}" alt="${game.name}" onerror="this.src='images/lelefonlogo2.png';"></div>
                    <p class="game-title">${game.name}</p>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading games:', error);
            gameGrid.innerHTML = '<p class="muted">Could not load games. Please ensure the backend server is running and accessible.</p>';
        }
    }

    // --- GAME CLICK AND MODAL LOGIC ---
    async function handleGameClick(game) {
        // The game object now comes directly from the database
        // It has a property `regionable` which is 1 for true, 0 for false
        if (game.regionable === 1) {
            try {
                const response = await fetch(`${API_BASE_URL}/regions?gameId=${game.id}`);
                const regions = await response.json();
                const regionGrid = document.getElementById('regionGrid');
                
                document.getElementById('modalTitle').textContent = `Select Region for ${game.name}`;
                regionGrid.innerHTML = regions.map(region => `
                    <button class="region-card" onclick="navigateToProduct('${game.id}', '${game.name}', '${region.region_key}', ${game.uid_required})">
                        <p>${region.flag || 'üåê'} ${region.name}</p>
                    </button>
                `).join('');
                document.getElementById('regionModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error fetching regions:', error);
                alert('Could not fetch regions for this game.');
            }
        } else {
            navigateToProduct(game.id, game.name, null, game.uid_required);
        }
    }

    function navigateToProduct(gameId, gameName, regionKey, uidRequired) {
        // The uidRequired property is 1 for true, 0 for false
        let url = `product.html?game=${encodeURIComponent(gameId)}&name=${encodeURIComponent(gameName)}&uid=${uidRequired}`;
        if (regionKey) {
            url += `&region=${encodeURIComponent(regionKey)}`;
        }
        location.href = url;
    }

    function closeModal() {
        document.getElementById('regionModal').classList.add('hidden');
    }

    // --- FILTER LOGIC ---
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const filter = btn.dataset.filter;
            document.querySelectorAll('.game-card').forEach(card => {
                card.style.display = (filter === 'all' || card.dataset.category === filter) ? 'block' : 'none';
            });
        };
    });

    // --- INITIAL PAGE LOAD ---
    document.addEventListener('DOMContentLoaded', () => {
        refreshNavbar();
        loadGames();
    });
</script>
</body>
</html>