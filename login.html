<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Lelefon • Login</title>
<link rel="icon" type="image/png" href="images/lelefonlogo2.png?v=2" sizes="192x192">
<link rel="stylesheet" href="homestyle.css"/>
<style>
  .wrap{width:min(520px,92vw);margin:40px auto}
  .card{border:1px solid #e6e6e6;border-radius:16px;background:#fff;padding:22px}
  .title{font-weight:800;font-size:1.4rem;margin-bottom:6px}
  .btn-row{display:flex;gap:10px}
  .divider { display: flex; align-items: center; text-align: center; color: #aaa; margin: 16px 0; }
  .divider::before, .divider::after { content: ''; flex: 1; border-bottom: 1px solid #e6e6e6; }
  .divider:not(:empty)::before { margin-right: .25em; }
  .divider:not(:empty)::after { margin-left: .25em; }
  #googleSignInButton { margin-bottom: 12px; display: flex; justify-content: center; }
</style>
</head>
<body>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<header class="navbar">
  <div class="navbar-inner">
    <div class="logo-container"><a href="index.html" class="logo-link"><img src="images/lelefonlogo.png" class="logo" alt=""><h1>Lelefon Gaming</h1></a></div>
    <nav class="right-area">
      <a href="index.html">Home</a><a href="transaction.html">Transactions</a><a href="profile.html">Profile</a>
      <span class="wallet-pill">LF Wallet: <span id="walletAmt">0.00</span> MYR</span>
      <a class="btn ghost" href="cart.html">Cart (<span id="cartCount">0</span>)</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <div class="title">Sign In</div>
    <div id="googleSignInButton"></div>

    <div class="divider">OR</div>

    <div class="field"><label>Email</label><input id="email" type="email" placeholder="you@email.com"/></div>
    <div class="field"><label>Password</label><input id="pass" type="password" placeholder="••••••••"/></div>
    <div class="btn-row" style="margin-top:8px">
      <button id="doLogin" class="btn primary">Login</button>
      <button id="doRegister" class="btn ghost">Register</button>
    </div>
    <div class="muted" style="margin-top:10px">Use Google Sign-In or register with email/password.</div>
  </div>
</main>

<script>
const API_BASE = 'https://api.lelefon-67.workers.dev/api';

const Store={read:(k,d)=>{try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},write:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};

// Wallet/cart UI (local)
const state={user:Store.read('lf_user',null),wallets:Store.read('lf_wallets',{}),cart:Store.read('lf_cart',[])};
const userBalance = state.user ? (state.wallets[state.user.email] || 0) : 0;
document.getElementById('walletAmt').textContent = userBalance.toFixed(2);
document.getElementById('cartCount').textContent=state.cart.reduce((s,i)=>s+(i.qty||1),0);

function gotoReturn(){ const back=new URLSearchParams(location.search).get('r'); location.href = back || 'index.html'; }

// =============== Google Sign-In ===============
window.onload = function () {
  google.accounts.id.initialize({
    client_id: "349262547313-jd6mbf9ie22bdb1ftae5lrp4krtni6di.apps.googleusercontent.com",
    callback: handleCredentialResponse
  });
  google.accounts.id.renderButton(
    document.getElementById("googleSignInButton"),
    { theme: "outline", size: "large", width: "350" }
  );
};

function jwt_decode(token) {
  const base64Url = token.split('.')[1];
  const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
  const jsonPayload = decodeURIComponent(atob(base64).split('').map(c =>
    '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
  ).join(''));
  return JSON.parse(jsonPayload);
}

async function handleCredentialResponse(response) {
  const decoded = jwt_decode(response.credential);
  const email = (decoded.email || '').toLowerCase();
  const name  = decoded.name || 'User';

  try {
    // ensure exists in DB
    await fetch(`${API_BASE}/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, provider: 'google' })
    });

    // login as user (provider google)
    await fetch(`${API_BASE}/login/user`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, provider: 'google' })
    });

    Store.write('lf_user', { email });
    alert(`Welcome, ${name}!`);
    gotoReturn();
  } catch (err) {
    console.error(err);
    alert('Google login failed.');
  }
}

// =============== Local email/password ===============
document.getElementById('doLogin').onclick = async () => {
  const email = document.getElementById('email').value.trim().toLowerCase();
  const pass  = document.getElementById('pass').value;
  if (!email || !pass) return alert('Enter email and password.');

  try {
    const res = await fetch(`${API_BASE}/login/user`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password: pass, provider: 'local' })
    });
    const json = await res.json();
    if (!res.ok || !json.success) {
      alert(json.message || 'Login failed.');
      return;
    }
    Store.write('lf_user', { email });
    alert('Logged in.');
    gotoReturn();
  } catch (err) {
    console.error(err);
    alert('Login error.');
  }
};

document.getElementById('doRegister').onclick = async () => {
  const email = document.getElementById('email').value.trim().toLowerCase();
  const pass  = document.getElementById('pass').value;
  if (!email || !pass) return alert('Enter email and password.');

  try {
    const res = await fetch(`${API_BASE}/register`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password: pass, provider: 'local' })
    });
    const json = await res.json();
    if (!res.ok || !json.success) {
      alert(json.message || 'Registration failed.');
      return;
    }

    // optional: keep small local cache for your wallet UI (unchanged behavior)
    const users = Store.read('lf_users', {});
    users[email] = { pass: btoa(pass) };
    Store.write('lf_users', users);

    Store.write('lf_user', { email });
    alert('Registered successfully!');
    gotoReturn();
  } catch (err) {
    console.error(err);
    alert('Registration error.');
  }
};
</script>
</body>
</html>
