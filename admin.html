<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lelefon Gaming - Admin Panel</title>
  <link rel="icon" type="image/png" href="images/lelefonlogo2.png?v=2" sizes="192x192">
  <link rel="stylesheet" href="homestyle.css">
  <style>
    .wrap { width: min(1200px, 92vw); margin: 24px auto; }
    .card { border: 1px solid var(--border); border-radius: 12px; background: #fff; padding: 16px; margin-bottom: 16px; }
    .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .table th, .table td { border: 1px solid var(--border); padding: 8px; text-align: left; vertical-align: top; }
    .table th { background-color: var(--bg-soft); font-weight: bold; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; margin-bottom: 4px; font-weight: bold; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; }
    .package-item { border-bottom: 1px solid #eee; padding: 8px 0; display: flex; justify-content: space-between; align-items: center; }
    .admin-controls { margin-top: 20px; }
    .hidden { display: none; }
    #adminLogin { max-width: 400px; margin: 50px auto; }
    .btn-row { display: flex; gap: 10px; margin-top: 8px; }
    .title { font-weight: 800; font-size: 1.4rem; margin-bottom: 6px; }
    .region-group h4 { margin: 16px 0 8px; padding-bottom: 4px; border-bottom: 1px solid #eee; }
    .section-header { font-size: 1.5rem; margin-bottom: 10px; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="navbar-inner">
      <div class="logo-container">
        <a href="/" class="logo-link">
          <img src="images/lelefonlogo.png" alt="Lelefon Logo" class="logo">
          <h1>Lelefon Gaming - Admin</h1>
        </a>
      </div>
      <nav class="right-area"><a href="/">Home</a><span id="authArea"></span></nav>
    </div>
  </header>

  <main class="wrap">
    <!-- Admin Login Form -->
    <div id="adminLogin">
      <div class="card">
        <div class="title">Admin Login</div>
        <div class="form-group">
          <label>Email</label>
          <input id="adminUser" type="email" placeholder="admin@email.com">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input id="adminPass" type="password" placeholder="••••••••">
        </div>
        <div class="btn-row">
          <button id="doAdminLogin" type="button" class="btn primary">Login</button>
        </div>
      </div>
    </div>

    <!-- Admin Content Panel -->
    <div id="adminContent" class="hidden">
      <h2>Admin Dashboard</h2>

      <div class="grid">
        <section class="card">
          <h3 class="section-header">1. Add/Edit Game</h3>
          <div class="form-group"><label>Game ID (e.g. 'mlbb', no spaces)</label><input id="gameId" type="text"></div>
          <div class="form-group"><label>Game Name (e.g. 'Mobile Legends')</label><input id="gameName" type="text"></div>
          <div class="form-group"><label>Image URL</label><input id="gameImg" type="text" value="images/lelefonlogo2.png"></div>
          <div class="form-group"><label>Category</label><select id="gameCat"><option value="direct">Direct Topup</option><option value="card">Game Card</option></select></div>
          <div class="form-group"><label>Options</label>
              <input type="checkbox" id="gameRegionable"> Has Multiple Regions? &nbsp;
              <input type="checkbox" id="gameUidReq" checked> Requires UID?
          </div>
          <button id="saveGameBtn" class="btn primary">Save Game</button>
        </section>

        <section class="card">
          <h3 class="section-header">2. Manage Packages</h3>
          <div class="form-group"><label>Select Game</label><select id="gameSelect"></select></div>
          <div id="regionArea" class="hidden form-group">
            <label>Select Region</label><select id="regionSelect"></select>
            <button id="addRegionBtn" class="btn ghost" style="font-size:0.8rem; margin-top:4px;">+ Add New Region</button>
          </div>
          <hr/>
          <div id="packageList"><p class="muted">Select a game to see packages.</p></div>
          <hr/>
          <h4>Add New Package</h4>
          <div class="form-group"><label for="packageName">Package Name:</label><input type="text" id="packageName" placeholder="e.g., 500 Diamonds"></div>
          <div class="form-group"><label for="packagePrice">Package Price (MYR):</label><input type="number" id="packagePrice" step="0.01" placeholder="e.g., 20.50"></div>
          <button id="addPackageBtn" class="btn primary">Add Package</button>
        </section>
      </div>

      <section class="card" id="orderManagement">
        <h3 class="section-header">Order Management</h3>
        <div id="orderList"><p class="muted">Loading recent orders...</p></div>
      </section>

      <div class="admin-controls">
        <button id="logoutAdmin" class="btn ghost">Logout</button>
      </div>
    </div>
  </main>

<script>
/* ------------------------------------------------------------------
   SHIM: if cached HTML calls handleLogin() inline, route it here.
   This makes both the inline call AND the new JS listener work.
-------------------------------------------------------------------*/
function handleAdminLoginSetupShim(fn) {
  // expose a global so any inline onsubmit/onclick=handleLogin() will work
  window.handleLogin = function (ev) {
    if (ev && typeof ev.preventDefault === 'function') ev.preventDefault();
    fn();                 // call the real handler
    return false;         // prevent default form submit if any
  };
}

const API_BASE_URL = 'https://api.lelefon-67.workers.dev/api';
let ALL_GAMES = [];

// --- DOM Elements ---
const adminLoginEl  = document.getElementById('adminLogin');
const adminContentEl= document.getElementById('adminContent');
const authAreaEl    = document.getElementById('authArea');
const gameSelectEl  = document.getElementById('gameSelect');
const logoutAdminBtn= document.getElementById('logoutAdmin');

// --- REAL LOGIN HANDLER ---
async function handleAdminLogin() {
  const email    = document.getElementById('adminUser').value.trim();
  const password = document.getElementById('adminPass').value.trim();
  if (!email || !password) { alert('Please fill in both fields.'); return; }

  try {
    const response = await fetch(`${API_BASE_URL}/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    const result = await response.json();

    if (response.ok && result.role === 'admin') {
      sessionStorage.setItem('isAdmin', 'true');
      showAdminPanel();
    } else {
      alert(result.message || 'Invalid admin credentials.');
    }
  } catch (err) {
    console.error(err);
    alert('Login failed. Please check server connection.');
  }
}

// Wire the click (modern way) AND expose the shim for any legacy inline call
document.getElementById('doAdminLogin').addEventListener('click', handleAdminLogin);
handleAdminLoginSetupShim(handleAdminLogin);

// --- LOGOUT ---
logoutAdminBtn.addEventListener('click', () => {
  sessionStorage.removeItem('isAdmin');
  adminLoginEl.classList.remove('hidden');
  adminContentEl.classList.add('hidden');
  authAreaEl.textContent = '';
});

// --- SHOW ADMIN PANEL ---
function showAdminPanel() {
  adminLoginEl.classList.add('hidden');
  adminContentEl.classList.remove('hidden');
  authAreaEl.innerHTML = `<span class="pill">Admin Logged In</span>`;
  loadInitialData();
}

// --- INITIAL DATA LOAD ---
async function loadInitialData() { await loadGames(); }

// --- LOAD GAMES ---
async function loadGames() {
  try {
    const response = await fetch(`${API_BASE_URL}/games`);
    ALL_GAMES = await response.json();
    gameSelectEl.innerHTML =
      '<option value="">-- Select a Game --</option>' +
      ALL_GAMES.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
  } catch (e) {
    console.error('Failed to load games', e);
  }
}

// --- SAVE GAME ---
document.getElementById('saveGameBtn').addEventListener('click', async () => {
  const gameData = {
    id: document.getElementById('gameId').value.trim(),
    name: document.getElementById('gameName').value.trim(),
    image_url: document.getElementById('gameImg').value.trim(),
    category: document.getElementById('gameCat').value,
    regionable: document.getElementById('gameRegionable').checked,
    uid_required: document.getElementById('gameUidReq').checked,
  };
  if (!gameData.id || !gameData.name) { alert('Game ID and Name are required.'); return; }

  await fetch(`${API_BASE_URL}/admin/game`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(gameData)
  });
  alert('Game saved successfully!');
  loadGames();
});

// --- REGION & PACKAGE MANAGEMENT ---
gameSelectEl.addEventListener('change', async (e) => {
  const gameId = e.target.value;
  const game   = ALL_GAMES.find(g => g.id === gameId);
  const regionArea = document.getElementById('regionArea');

  if (!game) {
    regionArea.classList.add('hidden');
    document.getElementById('packageList').innerHTML =
      '<p class="muted">Select a game to see packages.</p>';
    return;
  }

  if (game.regionable) {
    regionArea.classList.remove('hidden');
    await loadRegionsForGame(gameId);
  } else {
    regionArea.classList.add('hidden');
    await loadPackagesForGame(gameId, null);
  }
});

async function loadRegionsForGame(gameId) {
  const response = await fetch(`${API_BASE_URL}/regions?gameId=${gameId}`);
  const regions = await response.json();
  const regionSelectEl = document.getElementById('regionSelect');
  regionSelectEl.innerHTML = regions.map(r =>
    `<option value="${r.region_key}">${r.name}</option>`).join('');

  if (regions.length > 0) {
    loadPackagesForGame(gameId, regions[0].region_key);
  } else {
    document.getElementById('packageList').innerHTML =
      '<p class="muted">This game has no regions yet. Add one!</p>';
  }
  regionSelectEl.onchange = () => loadPackagesForGame(gameId, regionSelectEl.value);
}

document.getElementById('addRegionBtn').addEventListener('click', async () => {
  const gameId = gameSelectEl.value;
  if (!gameId) { alert('Please select a game first.'); return; }
  const regionKey = prompt('Enter a short Region Key (e.g., MY, GLOBAL):');
  const regionName= prompt('Enter full Region Name (e.g., Malaysia):');
  const flag      = prompt('Enter a flag emoji (optional):');
  if (regionKey && regionName) {
    await fetch(`${API_BASE_URL}/admin/region`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ game_id: gameId, region_key: regionKey, name: regionName, flag })
    });
    alert('Region added!');
    loadRegionsForGame(gameId);
  }
});

async function loadPackagesForGame(gameId, regionKey) {
  const packageListEl = document.getElementById('packageList');
  packageListEl.innerHTML = '<p class="muted">Loading packages...</p>';
  const response = await fetch(`${API_BASE_URL}/packages?gameId=${gameId}&regionKey=${regionKey || ''}`);
  const packages = await response.json();

  if (packages.length > 0) {
    packageListEl.innerHTML = packages.map(pkg => `
      <div class="package-item">
        <span>${pkg.label} - ${pkg.price.toFixed(2)} MYR</span>
        <button class="btn ghost" onclick="deletePackage('${pkg.id}')">Delete</button>
      </div>
    `).join('');
  } else {
    packageListEl.innerHTML = '<p class="muted">No packages for this selection yet.</p>';
  }
}

window.deletePackage = async (packageId) => {
  if (confirm('Are you sure you want to delete this package?')) {
    await fetch(`${API_BASE_URL}/admin/package?id=${packageId}`, { method: 'DELETE' });
    gameSelectEl.dispatchEvent(new Event('change'));
  }
};

// --- AUTO LOGIN ---
if (sessionStorage.getItem('isAdmin') === 'true') {
  showAdminPanel();
}
</script>

</body>
</html>
