<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lelefon Gaming - Admin Panel</title>
  <link rel="icon" type="image/png" href="images/lelefonlogo2.png?v=2" sizes="192x192">
  <link rel="stylesheet" href="homestyle.css">
  <style>
    .wrap { width: min(1200px, 92vw); margin: 24px auto; }
    .card { border: 1px solid var(--border); border-radius: 12px; background: #fff; padding: 16px; margin-bottom: 16px; }
    .table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .table th, .table td { border: 1px solid var(--border); padding: 8px; text-align: left; vertical-align: top; }
    .table th { background-color: var(--bg-soft); font-weight: bold; }
    .form-group { margin-bottom: 12px; }
    .form-group label { display: block; margin-bottom: 4px; font-weight: bold; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; }
    .package-item { border-bottom: 1px solid #eee; padding: 8px 0; display: grid; grid-template-columns: 1fr 120px 120px 220px; gap: 8px; align-items: center; }
    .admin-controls { margin-top: 20px; }
    .hidden { display: none; }
    #adminLogin { max-width: 400px; margin: 50px auto; }
    .btn-row { display: flex; gap: 10px; margin-top: 8px; }
    .title { font-weight: 800; font-size: 1.4rem; margin-bottom: 6px; }
    .section-header { font-size: 1.5rem; margin-bottom: 10px; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

    .order-items { background:#fafafa; border:1px dashed var(--border); border-radius:8px; padding:10px; margin:8px 0 0; }
    .order-items h4 { margin:2px 0 8px; }
    .pin-row { display:flex; gap:6px; align-items:center; }
    .pin-row input { width: 260px; }
    .muted { opacity: .65; }

    .pill-s { display:inline-block; padding:3px 8px; border-radius:999px; border:1px solid var(--border); font-size:.8rem; }
    .status-Processing { background:#fff8e6; border-color:#f3d27a; }
    .status-Completed { background:#eaf8ef; border-color:#9bd4b0; }
    .status-Cancelled { background:#fde8e8; border-color:#f3b1b1; }
    .status-Refunded { background:#e9f2ff; border-color:#b7d2ff; }
    .btn[disabled], .btn.ghost[disabled] { opacity:.5; pointer-events:none; }
    .pkg-actions { display:flex; gap:8px; justify-content:flex-end; }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="navbar-inner">
      <div class="logo-container">
        <a href="/" class="logo-link">
          <img src="images/lelefonlogo.png" alt="Lelefon Logo" class="logo">
          <h1>Lelefon Gaming - Admin</h1>
        </a>
      </div>
      <nav class="right-area"><a href="/">Home</a><span id="authArea"></span></nav>
    </div>
  </header>

  <main class="wrap">
    <!-- Admin Login Form -->
    <div id="adminLogin">
      <div class="card">
        <div class="title">Admin Login</div>
        <form>
          <div class="form-group">
            <label>Email</label>
            <input id="adminUser" type="email" placeholder="admin@email.com" required>
          </div>
          <div class="form-group">
            <label>Password</label>
            <input id="adminPass" type="password" placeholder="••••••••" required>
          </div>
          <div class="btn-row">
            <button id="doAdminLogin" type="submit" class="btn primary">Login</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Admin Content Panel -->
    <div id="adminContent" class="hidden">
      <h2>Admin Dashboard</h2>

      <div class="grid">
        <section class="card">
          <h3 class="section-header">1. Add/Edit Game</h3>
          <div class="form-group"><label>Game ID</label><input id="gameId" type="text"></div>
          <div class="form-group"><label>Game Name</label><input id="gameName" type="text"></div>
          <div class="form-group"><label>Image URL</label><input id="gameImg" type="text" value="images/lelefonlogo2.png"></div>
          <div class="form-group"><label>Category</label>
            <select id="gameCat">
              <option value="direct">Direct Topup</option>
              <option value="card">Game Card</option>
            </select>
          </div>
          <div class="form-group"><label>Options</label>
            <input type="checkbox" id="gameRegionable"> Has Multiple Regions?
            <input type="checkbox" id="gameUidReq" checked> Requires UID?
          </div>
          <div class="btn-row">
            <button id="saveGameBtn" class="btn primary" type="button">Save Game</button>
            <button id="deleteGameBtn" class="btn danger" type="button">Delete Game</button>
          </div>
        </section>

        <section class="card">
          <h3 class="section-header">2. Manage Packages</h3>
          <div class="form-group"><label>Select Game</label><select id="gameSelect"></select></div>
          <div id="regionArea" class="hidden form-group">
            <label>Select Region</label><select id="regionSelect"></select>
            <button id="addRegionBtn" class="btn ghost" style="font-size:0.8rem; margin-top:4px;">+ Add New Region</button>
          </div>
          <hr/>
          <div id="packageList"><p class="muted">Select a game to see packages.</p></div>
          <hr/>
          <h4>Add New Package</h4>
          <div class="form-group"><label>Package Name</label><input id="packageName" type="text"></div>
          <div class="form-group"><label>Package Price (MYR)</label><input id="packagePrice" type="number" step="0.01"></div>
          <div class="form-group"><label>Discount % (0-100)</label><input id="packageDiscount" type="number" min="0" max="100" step="1" value="0"></div>
          <button id="addPackageBtn" class="btn primary">Add Package</button>
        </section>
      </div>

      <section class="card">
        <h3 class="section-header">Order Management</h3>
        <div id="orderList"><p class="muted">Loading recent orders...</p></div>
      </section>

      <section class="card">
        <h3 class="section-header">User & Wallet Management</h3>
        <div id="userList"><p class="muted">Loading users...</p></div>
      </section>

      <div class="admin-controls">
        <button id="logoutAdmin" class="btn ghost">Logout</button>
      </div>
    </div>
  </main>

<script>
const API_BASE_URL = 'https://api.lelefon-67.workers.dev/api';
let ALL_GAMES = [];

// Elements
const adminLoginEl = document.getElementById('adminLogin');
const adminContentEl = document.getElementById('adminContent');
const authAreaEl = document.getElementById('authArea');
const gameSelectEl = document.getElementById('gameSelect');
const logoutAdminBtn = document.getElementById('logoutAdmin');

// LOGIN HANDLER
async function handleAdminLogin(event) {
  event.preventDefault();
  const email = document.getElementById('adminUser').value.trim();
  const password = document.getElementById('adminPass').value.trim();
  if (!email || !password) return alert('Please fill in both fields.');

  try {
    const response = await fetch(`${API_BASE_URL}/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
    const result = await response.json();
    if (result.role === 'admin') {
      sessionStorage.setItem('isAdmin', 'true');
      showAdminPanel();
    } else {
      alert(result.message || 'Invalid admin credentials.');
    }
  } catch (err) {
    console.error('Login failed:', err);
    alert('Login failed. The server might be down or an error occurred.');
  }
}
document.querySelector('#adminLogin form').addEventListener('submit', handleAdminLogin);

// Logout
logoutAdminBtn.addEventListener('click', () => {
  sessionStorage.removeItem('isAdmin');
  adminLoginEl.classList.remove('hidden');
  adminContentEl.classList.add('hidden');
  authAreaEl.innerHTML = '';
});

// Show admin panel
function showAdminPanel() {
  adminLoginEl.classList.add('hidden');
  adminContentEl.classList.remove('hidden');
  authAreaEl.innerHTML = `<span class="pill">Admin Logged In</span>`;
  loadGames();
  loadUsers();
  loadOrders();
}

// Load games
async function loadGames() {
  try {
    const response = await fetch(`${API_BASE_URL}/games`);
    ALL_GAMES = await response.json();
    gameSelectEl.innerHTML = '<option value="">-- Select a Game --</option>' +
      ALL_GAMES.map(g => `<option value="${g.id}">${g.name}</option>`).join('');
  } catch (e) {
    console.error('Failed to load games', e);
  }
}

// Load Users & Wallets
async function loadUsers() {
  const userListEl = document.getElementById('userList');
  try {
    const response = await fetch(`${API_BASE_URL}/admin/users`);
    if (!response.ok) throw new Error('Failed to fetch users.');
    const users = await response.json();

    if (users.length) {
      let tableHtml = `<table class="table">
        <thead><tr><th>Email</th><th>Role</th><th>Balance (MYR)</th><th>Actions</th></tr></thead>
        <tbody>`;
      for (const user of users) {
        tableHtml += `
          <tr>
            <td>${user.email}</td>
            <td>${user.role}</td>
            <td>${(user.balance || 0).toFixed(2)}</td>
            <td><button class="btn ghost" onclick="editWallet('${user.email}')">Set Balance</button></td>
          </tr>`;
      }
      tableHtml += '</tbody></table>';
      userListEl.innerHTML = tableHtml;
    } else {
      userListEl.innerHTML = '<p>No users found.</p>';
    }
  } catch (err) {
    console.error('Failed to load users:', err);
    userListEl.innerHTML = '<p class="danger">Could not load user data.</p>';
  }
}

window.editWallet = async (email) => {
  const currentBalance = prompt(`Enter new balance for ${email}:`, '0.00');
  if (currentBalance === null) return;

  const newBalance = parseFloat(currentBalance);
  if (isNaN(newBalance)) return alert('Invalid number provided.');

  try {
    const response = await fetch(`${API_BASE_URL}/admin/wallet`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, newBalance })
    });
    if (!response.ok) throw new Error('Server rejected the update.');
    alert('Wallet updated successfully!');
    loadUsers();
  } catch (err) {
    console.error('Failed to update wallet:', err);
    alert('An error occurred while updating the wallet.');
  }
};

// Save / Delete game
document.getElementById('saveGameBtn').addEventListener('click', async () => {
  const gameData = {
    id: document.getElementById('gameId').value.trim(),
    name: document.getElementById('gameName').value.trim(),
    image_url: document.getElementById('gameImg').value.trim(),
    category: document.getElementById('gameCat').value,
    regionable: document.getElementById('gameRegionable').checked,
    uid_required: document.getElementById('gameUidReq').checked,
  };
  if (!gameData.id || !gameData.name) return alert('Game ID and Name are required.');

  await fetch(`${API_BASE_URL}/admin/game`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(gameData)
  });
  alert('Game saved successfully!');
  loadGames();
});

document.getElementById('deleteGameBtn').addEventListener('click', async () => {
  const id = document.getElementById('gameId').value.trim();
  if (!id) return alert('Enter the Game ID to delete.');
  if (!confirm(`Delete game "${id}"? This will also remove its packages and regions.`)) return;
  const res = await fetch(`${API_BASE_URL}/admin/game?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
  if (!res.ok) return alert('Failed to delete game.');
  alert('Game deleted.');
  document.getElementById('gameId').value = '';
  loadGames();
  gameSelectEl.dispatchEvent(new Event('change'));
});

// Packages & Regions
gameSelectEl.addEventListener('change', async e => {
  const gameId = e.target.value;
  const game = ALL_GAMES.find(g => g.id === gameId);
  const regionArea = document.getElementById('regionArea');

  if (!game) {
    regionArea.classList.add('hidden');
    document.getElementById('packageList').innerHTML = '<p>Select a game to see packages.</p>';
    return;
  }
  if (game.regionable) {
    regionArea.classList.remove('hidden');
    await loadRegionsForGame(gameId);
  } else {
    regionArea.classList.add('hidden');
    await loadPackagesForGame(gameId, ''); // IMPORTANT: empty string for no-region games
  }
});

async function loadRegionsForGame(gameId) {
  const res = await fetch(`${API_BASE_URL}/regions?gameId=${encodeURIComponent(gameId)}`);
  const regions = await res.json();
  const regionSelectEl = document.getElementById('regionSelect');
  regionSelectEl.innerHTML = regions.map(r => `<option value="${r.region_key}">${r.name}</option>`).join('');
  if (regions.length) loadPackagesForGame(gameId, regions[0].region_key);
  regionSelectEl.onchange = () => loadPackagesForGame(gameId, regionSelectEl.value);
}

document.getElementById('addRegionBtn').addEventListener('click', async () => {
  const gameId = gameSelectEl.value;
  if (!gameId) return alert('Please select a game first.');
  const regionKey = prompt('Enter region key (e.g., MY)');
  const regionName = prompt('Enter full region name (e.g., Malaysia)');
  const flag = prompt('Flag emoji (optional)');
  if (regionKey && regionName) {
    await fetch(`${API_BASE_URL}/admin/region`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ game_id: gameId, region_key: regionKey, name: regionName, flag })
    });
    alert('Region added!');
    loadRegionsForGame(gameId);
  }
});

async function loadPackagesForGame(gameId, regionKey) {
  const packageListEl = document.getElementById('packageList');
  packageListEl.innerHTML = '<p>Loading packages...</p>';
  const res = await fetch(`${API_BASE_URL}/packages?gameId=${encodeURIComponent(gameId)}&regionKey=${encodeURIComponent(regionKey || '')}`);
  const packages = await res.json();
  if (packages.length) {
    packageListEl.innerHTML = packages.map(pkg => `
      <div class="package-item">
        <input id="pkg-label-${pkg.id}" type="text" value="${pkg.label}">
        <input id="pkg-price-${pkg.id}" type="number" step="0.01" value="${(+pkg.price).toFixed(2)}">
        <input id="pkg-disc-${pkg.id}" type="number" min="0" max="100" step="1" value="${+(pkg.discount_pct || 0)}" title="Discount %">
        <div class="pkg-actions">
          <button class="btn" onclick="savePackage('${pkg.id}')">Save</button>
          <button class="btn ghost" onclick="deletePackage('${pkg.id}')">Delete</button>
        </div>
      </div>`).join('');
  } else {
    packageListEl.innerHTML = '<p>No packages found.</p>';
  }
}

// Keep helpers to reload the same region after actions
function getCurrentGameAndRegion() {
  const gameId = gameSelectEl.value;
  const game = ALL_GAMES.find(g => g.id === gameId);
  const regionEl = document.getElementById('regionSelect');
  const regionKey = game && game.regionable ? (regionEl ? regionEl.value : null) : ''; // empty string for no-region
  return { gameId, regionKey, game };
}

window.savePackage = async (id) => {
  const labelEl = document.getElementById(`pkg-label-${id}`);
  const priceEl = document.getElementById(`pkg-price-${id}`);
  const discEl  = document.getElementById(`pkg-disc-${id}`);
  const label = labelEl ? labelEl.value.trim() : null;
  const price = priceEl ? parseFloat(priceEl.value) : null;
  const discount_pct = discEl ? parseFloat(discEl.value) : null;

  if (label === '' || price === null || isNaN(price) || discount_pct === null || isNaN(discount_pct) || discount_pct < 0 || discount_pct > 100) {
    return alert('Please provide a valid name, price, and discount % (0–100).');
  }
  try {
    const res = await fetch(`${API_BASE_URL}/admin/package`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, label, price, discount_pct })
    });
    if (!res.ok) throw new Error('Update failed');
    alert('Package updated!');

    const { gameId, regionKey } = getCurrentGameAndRegion();
    await loadPackagesForGame(gameId, regionKey);
    const regionEl = document.getElementById('regionSelect');
    if (regionEl && regionKey != null) regionEl.value = regionKey;
  } catch (e) {
    console.error(e);
    alert('Could not update package.');
  }
};

window.deletePackage = async id => {
  if (!confirm('Delete this package?')) return;
  const { gameId, regionKey } = getCurrentGameAndRegion();
  await fetch(`${API_BASE_URL}/admin/package?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
  await loadPackagesForGame(gameId, regionKey);
  const regionEl = document.getElementById('regionSelect');
  if (regionEl && regionKey != null) regionEl.value = regionKey;
};

document.getElementById('addPackageBtn').addEventListener('click', async () => {
  const { gameId, regionKey, game } = getCurrentGameAndRegion();
  if (!game) return alert('Select a game first.');
  const label = document.getElementById('packageName').value.trim();
  const price = parseFloat(document.getElementById('packagePrice').value);
  const discount_pct = parseFloat(document.getElementById('packageDiscount').value || '0');
  if (!label || isNaN(price) || isNaN(discount_pct) || discount_pct < 0 || discount_pct > 100) return alert('Enter name, price, and valid discount %.');

  // IMPORTANT: for non-region games, send empty string
  const sendRegion = game.regionable ? (regionKey || '') : '';

  const res = await fetch(`${API_BASE_URL}/admin/package`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ game_id: gameId, region_key: sendRegion, label, price, discount_pct })
  });
  if (!res.ok) {
    const t = await res.text().catch(()=> '');
    alert('Failed to add package.' + (t ? `\n${t}` : ''));
    return;
  }

  alert('Package added!');
  document.getElementById('packageName').value = '';
  document.getElementById('packagePrice').value = '';
  document.getElementById('packageDiscount').value = '0';

  await loadPackagesForGame(gameId, sendRegion);
  const regionEl = document.getElementById('regionSelect');
  if (regionEl && sendRegion != null) regionEl.value = sendRegion;
});

// ---------- Order Management ----------
async function loadOrders(){
  const el = document.getElementById('orderList');
  el.innerHTML = '<p class="muted">Loading recent orders...</p>';
  try {
    const res = await fetch(`${API_BASE_URL}/admin/orders`);
    if (!res.ok) throw new Error('Failed to load orders.');
    const orders = await res.json();
    if (!orders.length) {
      el.innerHTML = '<p>No orders yet.</p>';
      return;
    }
    let html = `<table class="table">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>User</th>
          <th>Total (MYR)</th>
          <th>Method</th>
          <th>Status</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead><tbody>`;
    for (const o of orders) {
      const isProcessing = o.status === 'Processing';
      const isCancelled  = o.status === 'Cancelled';

      html += `<tr id="row-${o.id}">
        <td><strong>${o.id}</strong></td>
        <td>${o.user_email}</td>
        <td>${(+o.total).toFixed(2)}</td>
        <td>${o.payment_method}</td>
        <td><span class="pill-s status-${o.status}">${o.status}</span></td>
        <td>${o.created_at}</td>
        <td>
          <button class="btn ghost" onclick="toggleOrder('${o.id}')">View</button>
          <button class="btn"      onclick="completeOrder('${o.id}')" ${(!isProcessing)?'disabled':''}>Complete</button>
          <button class="btn ghost" onclick="cancelOrder('${o.id}')"   ${(!isProcessing)?'disabled':''}>Cancel</button>
          <button class="btn danger" onclick="refundOrder('${o.id}')"  ${(!isCancelled)?'disabled':''}>Refund</button>
        </td>
      </tr>
      <tr id="items-${o.id}" class="hidden"><td colspan="7"><div class="order-items" id="itemsBox-${o.id}">Loading items…</div></td></tr>`;
    }
    html += '</tbody></table>';
    el.innerHTML = html;
  } catch (err) {
    console.error(err);
    el.innerHTML = '<p class="danger">Could not load orders.</p>';
  }
}

window.toggleOrder = async (orderId) => {
  const row = document.getElementById(`items-${orderId}`);
  row.classList.toggle('hidden');
  if (!row.classList.contains('hidden')) {
    const box = document.getElementById(`itemsBox-${orderId}`);
    box.innerHTML = 'Loading items…';
    try {
      const res = await fetch(`${API_BASE_URL}/admin/order-items?orderId=${encodeURIComponent(orderId)}`);
      const items = await res.json();
      if (!items.length) { box.innerHTML = '<div class="muted">No items.</div>'; return; }
      box.innerHTML = `
        <h4>Items</h4>
        <table class="table">
          <thead><tr><th>#</th><th>Game</th><th>Package</th><th>Qty</th><th>Price</th><th>UID</th><th>PIN (for card)</th></tr></thead>
          <tbody>
            ${items.map(it => `
              <tr>
                <td>${it.id}</td>
                <td>${it.game_name}</td>
                <td>${it.package_label}</td>
                <td>${it.quantity}</td>
                <td>${(+it.price_at_purchase).toFixed(2)}</td>
                <td>${it.uid || '-'}</td>
                <td>
                  <div class="pin-row">
                    <input type="text" id="pin-${orderId}-${it.id}" placeholder="Enter PIN…" value="${it.pin || ''}">
                    <button class="btn ghost" onclick="savePin('${orderId}', ${it.id})">Save</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;
    } catch(e) {
      box.innerHTML = '<div class="danger">Failed to load items.</div>';
    }
  }
};

window.savePin = async (orderId, itemId) => {
  const input = document.getElementById(`pin-${orderId}-${itemId}`);
  try {
    const res = await fetch(`${API_BASE_URL}/admin/order/pin`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ order_id: orderId, item_id: itemId, pin: input.value.trim() })
    });
    if (!res.ok) throw new Error('Failed to save PIN.');
    alert('PIN saved.');
  } catch(e) {
    alert('Could not save PIN.');
  }
};

async function changeStatus(orderId, endpoint, successMsg){
  const btnCell = document.querySelector(`#row-${orderId} td:last-child`);
  const old = btnCell.innerHTML;
  btnCell.innerHTML = '<span class="muted">Processing…</span>';
  try {
    const res = await fetch(`${API_BASE_URL}${endpoint}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ order_id: orderId })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || 'Failed.');
    alert(successMsg);
    loadOrders(); // refresh table
  } catch(e) {
    alert(e.message || 'Action failed.');
    btnCell.innerHTML = old;
  }
}

window.completeOrder = (orderId)=> changeStatus(orderId, '/admin/order/complete', 'Order marked as Completed.');
window.cancelOrder   = (orderId)=> changeStatus(orderId, '/admin/order/cancel',   'Order marked as Cancelled.');
window.refundOrder   = (orderId)=> changeStatus(orderId, '/admin/order/refund',   'Order refunded.');

if (sessionStorage.getItem('isAdmin') === 'true') showAdminPanel();
</script>
</body>
</html>
