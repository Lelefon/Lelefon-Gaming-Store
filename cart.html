<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Lelefon • Cart</title>
<link rel="icon" type="image/png" href="images/lelefonlogo2.png?v=2" sizes="192x192">
<link rel="stylesheet" href="homestyle.css"/>
<style>
  .wrap{width:min(1100px,92vw);margin:24px auto}
  .card{border:1px solid #e6e6e6;border-radius:12px;background:#fff;padding:14px}
  .row{display:grid;grid-template-columns:1fr auto;gap:10px;border:1px solid #eee;border-radius:12px;padding:12px;margin-bottom:10px}
  .qty{display:flex;align-items:center;gap:6px}
  .qty input{width:64px;text-align:center}
  .total{display:flex;justify-content:space-between;font-weight:800;margin-top:8px}
  .muted{opacity:.6}
</style>
</head>
<body>
<header class="navbar">
  <div class="navbar-inner">
    <div class="logo-container"><a href="index.html" class="logo-link"><img src="images/lelefonlogo.png" class="logo" alt=""><h1>Lelefon Gaming</h1></a></div>
    <nav class="right-area">
      <a href="index.html">Home</a><a href="transaction.html">Transactions</a><a href="profile.html">Profile</a>
      <span class="wallet-pill">LF Wallet: <span id="walletAmt">0.00</span> MYR</span>
      <a class="btn ghost" href="cart.html">Cart (<span id="cartCount">0</span>)</a>
      <span id="authArea"><a class="btn primary" href="login.html">Login</a></span>
    </nav>
  </div>
</header>

<main class="wrap">
  <h2>Shopping Cart</h2>
  <div id="list"></div>
  <div class="card">
    <div class="total"><span>Total</span><span id="total">0.00 MYR</span></div>
    <div style="display:flex;gap:10px;margin-top:10px">
      <a class="btn ghost" href="index.html">Continue Shopping</a>
      <span style="flex:1"></span>
      <button id="checkout" class="btn primary">Checkout</button>
    </div>
  </div>
</main>

<script>
    const API_BASE_URL = 'https://api.lelefon-67.workers.dev/api';
    const Store = {
        read: (k, d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d } catch { return d; } },
        write: (k, v) => localStorage.setItem(k, JSON.stringify(v))
    };
    
    const user = Store.read('lf_user');
    let cart = Store.read('lf_cart', []);

    async function refreshNavbar() {
        document.getElementById('cartCount').textContent = cart.reduce((s, i) => s + (i.qty || 1), 0);
        
        if (user) {
            document.getElementById('authArea').innerHTML = `<span class="pill">Hi, ${user.email}</span>`;
            try {
                const response = await fetch(`${API_BASE_URL}/wallet?email=${user.email}`);
                const data = await response.json();
                document.getElementById('walletAmt').textContent = data.balance.toFixed(2) + ' MYR';
            } catch (e) { document.getElementById('walletAmt').textContent = 'Error'; }
        } else {
            document.getElementById('authArea').innerHTML = `<a class="btn primary" href="login.html">Login</a>`;
            document.getElementById('walletAmt').textContent = '0.00 MYR';
        }
    }

    const listEl = document.getElementById('list');
    const totalEl = document.getElementById('total');

    function saveAndRedraw() {
        Store.write('lf_cart', cart);
        refreshNavbar();
        drawCart();
    }

    function drawCart() {
        if (cart.length === 0) {
            listEl.innerHTML = '<div class="muted">Your cart is empty.</div>';
            totalEl.textContent = '0.00 MYR';
            return;
        }

        listEl.innerHTML = cart.map(item => `
            <div class="row" data-key="${item.key}">
                <div>
                    <strong>${item.gameName}</strong> — ${item.pkgLabel}
                    <div class="muted">${item.uid ? 'UID: ' + item.uid : 'Game Card'}</div>
                    <div class="qty" style="margin-top:6px">
                        <button class="btn ghost decr" data-key="${item.key}">-</button>
                        <input class="q" type="number" min="1" value="${item.qty}" data-key="${item.key}">
                        <button class="btn ghost incr" data-key="${item.key}">+</button>
                        <span class="badge-small" style="margin-left:auto">Unit ${item.price.toFixed(2)} MYR</span>
                    </div>
                </div>
                <div>
                    <div style="text-align:right;font-weight:800">${(item.price * item.qty).toFixed(2)} MYR</div>
                    <button class="btn ghost remove" style="margin-top:6px" data-key="${item.key}">Remove</button>
                </div>
            </div>`).join('');
        
        const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        totalEl.textContent = total.toFixed(2) + ' MYR';

        // Add event listeners after drawing
        addEventListeners();
    }
    
    function addEventListeners() {
        document.querySelectorAll('.remove').forEach(button => {
            button.onclick = (e) => {
                cart = cart.filter(item => item.key.toString() !== e.target.dataset.key);
                saveAndRedraw();
            };
        });
        document.querySelectorAll('.decr').forEach(button => {
            button.onclick = (e) => updateQuantity(e.target.dataset.key, -1);
        });
        document.querySelectorAll('.incr').forEach(button => {
            button.onclick = (e) => updateQuantity(e.target.dataset.key, 1);
        });
        document.querySelectorAll('.q').forEach(input => {
            input.onchange = (e) => {
                const item = cart.find(i => i.key.toString() === e.target.dataset.key);
                if (item) {
                    item.qty = Math.max(1, parseInt(e.target.value) || 1);
                    saveAndRedraw();
                }
            };
        });
    }
    
    function updateQuantity(key, change) {
        const item = cart.find(i => i.key.toString() === key);
        if (item) {
            item.qty = Math.max(1, item.qty + change);
            saveAndRedraw();
        }
    }

    document.getElementById('checkout').onclick = () => {
        if (!user) {
            alert('Please login to checkout.');
            location.href = `login.html?r=cart.html`;
            return;
        }
        if (cart.length === 0) {
            alert('Your cart is empty.');
            return;
        }
        // Move cart items to 'pending' for the checkout page
        Store.write('lf_pending', cart);
        location.href = 'checkout.html?mode=cart';
    };

    // Initial Load
    document.addEventListener('DOMContentLoaded', () => {
        refreshNavbar();
        drawCart();
    });
</script>
</body>
</html>